<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Dashboard - Real-time Data Visualization</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        .chart-container {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid #444;
        }
        .control-panel {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .driver-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .driver-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 2px solid #444;
            background: #2d2d2d;
            cursor: pointer;
            transition: all 0.3s;
        }
        .driver-badge.selected {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .driver-badge:hover {
            border-color: #dc3545;
        }
        .quick-viz-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            margin: 0.5rem;
            transition: transform 0.2s;
        }
        .quick-viz-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-racing-car text-danger"></i> F1 Analytics
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/telemetry">Telemetry</a>
                <a class="nav-link" href="/docs">API Docs</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-5 text-primary">
                <i class="fas fa-chart-line"></i> F1 Telemetry Dashboard
            </h1>
            <p class="lead text-muted">Real-time telemetry data visualization and analysis</p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h4><i class="fas fa-sliders-h"></i> Session Configuration</h4>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Year</label>
                    <select class="form-select" id="yearSelect">
                        <option value="2025">2025</option>
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Grand Prix</label>
                    <select class="form-select" id="grandPrixSelect">
                        <option value="Bahrain" selected>Bahrain</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Australia">Australia</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="Miami">Miami</option>
                        <option value="Emilia Romagna">Emilia Romagna</option>
                        <option value="Monaco">Monaco</option>
                        <option value="Canada">Canada</option>
                        <option value="Spain">Spain</option>
                        <option value="Austria">Austria</option>
                        <option value="Great Britain">Great Britain</option>
                        <option value="Hungary">Hungary</option>
                        <option value="Belgium">Belgium</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Italy">Italy</option>
                        <option value="Singapore">Singapore</option>
                        <option value="United States">United States</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Las Vegas">Las Vegas</option>
                        <option value="Qatar">Qatar</option>
                        <option value="Abu Dhabi">Abu Dhabi</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Session</label>
                    <select class="form-select" id="sessionSelect">
                        <option value="Practice 1">Practice 1</option>
                        <option value="Practice 2">Practice 2</option>
                        <option value="Practice 3">Practice 3</option>
                        <option value="Qualifying">Qualifying</option>
                        <option value="Race" selected>Race</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Lap Type</label>
                    <select class="form-select" id="lapTypeSelect">
                        <option value="fastest" selected>Fastest Lap</option>
                        <option value="first">First Lap</option>
                    </select>
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">Select Drivers for Comparison</label>
                <div class="driver-selector" id="driverSelector">
                    <div class="driver-badge selected" data-driver="VER">VER</div>
                    <div class="driver-badge selected" data-driver="HAM">HAM</div>
                    <div class="driver-badge" data-driver="LEC">LEC</div>
                    <div class="driver-badge" data-driver="RUS">RUS</div>
                    <div class="driver-badge" data-driver="SAI">SAI</div>
                    <div class="driver-badge" data-driver="NOR">NOR</div>
                    <div class="driver-badge" data-driver="PIA">PIA</div>
                    <div class="driver-badge" data-driver="ALO">ALO</div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button class="quick-viz-btn" onclick="loadTelemetryCharts()">
                    <i class="fas fa-chart-area"></i> Load Telemetry Charts
                </button>
                <button class="quick-viz-btn" onclick="loadSectorAnalysis()">
                    <i class="fas fa-stopwatch"></i> Sector Analysis
                </button>
                <button class="quick-viz-btn" onclick="loadLapEvolution()">
                    <i class="fas fa-trending-up"></i> Lap Evolution
                </button>
                <button class="quick-viz-btn" onclick="loadPerformanceAnalysis()">
                    <i class="fas fa-cogs"></i> Performance Analysis
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading F1 data and generating visualizations...</p>
        </div>

        <!-- Telemetry Charts -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container" id="speedChartContainer" style="display: none;">
                    <h5><i class="fas fa-tachometer-alt"></i> Speed Comparison</h5>
                    <div id="speedChart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container" id="throttleBrakeContainer" style="display: none;">
                    <h5><i class="fas fa-car"></i> Throttle & Brake</h5>
                    <div id="throttleBrakeChart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container" id="rpmGearContainer" style="display: none;">
                    <h5><i class="fas fa-cog"></i> RPM & Gear</h5>
                    <div id="rpmGearChart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container" id="sectorChartContainer" style="display: none;">
                    <h5><i class="fas fa-flag-checkered"></i> Sector Times</h5>
                    <div id="sectorChart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container" id="lapEvolutionContainer" style="display: none;">
                    <h5><i class="fas fa-chart-line"></i> Lap Time Evolution</h5>
                    <div id="lapEvolutionChart"></div>
                </div>
            </div>
        </div>

        <!-- DRS Chart -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container" id="drsChartContainer" style="display: none;">
                    <h5><i class="fas fa-wind"></i> DRS Usage</h5>
                    <div id="drsChart"></div>
                </div>
            </div>
        </div>

        <!-- Performance Analysis -->
        <div class="row" id="performanceAnalysisContainer" style="display: none;">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-exchange-alt"></i> Overtaking Analysis</h5>
                    <div id="overtakingData"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-gas-pump"></i> Fuel Effect Analysis</h5>
                    <div id="fuelEffectData"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedDrivers = ['VER', 'HAM'];

        // Driver selection functionality
        document.addEventListener('DOMContentLoaded', function() {
            const driverBadges = document.querySelectorAll('.driver-badge');
            
            driverBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    const driver = this.dataset.driver;
                    
                    if (this.classList.contains('selected')) {
                        if (selectedDrivers.length > 1) {  // Keep at least one driver selected
                            this.classList.remove('selected');
                            selectedDrivers = selectedDrivers.filter(d => d !== driver);
                        }
                    } else {
                        if (selectedDrivers.length < 4) {  // Limit to 4 drivers for readability
                            this.classList.add('selected');
                            selectedDrivers.push(driver);
                        }
                    }
                });
            });
        });

        // Loading management
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function hideAllCharts() {
            const containers = ['speedChartContainer', 'throttleBrakeContainer', 'rpmGearContainer', 
                              'sectorChartContainer', 'lapEvolutionContainer', 'drsChartContainer', 
                              'performanceAnalysisContainer'];
            containers.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }

        // API call functions
        async function loadTelemetryCharts() {
            showLoading();
            hideAllCharts();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            const lapType = document.getElementById('lapTypeSelect').value;
            
            const params = new URLSearchParams({
                year: year,
                grand_prix: grandPrix,
                session: session,
                lap_type: lapType
            });
            
            selectedDrivers.forEach(driver => params.append('drivers', driver));
            
            try {
                const response = await fetch(`/api/telemetry-charts?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Display charts
                if (data.telemetry_charts) {
                    const charts = data.telemetry_charts;
                    
                    if (charts.speed_chart) {
                        Plotly.newPlot('speedChart', charts.speed_chart.data, charts.speed_chart.layout, {responsive: true});
                        document.getElementById('speedChartContainer').style.display = 'block';
                    }
                    
                    if (charts.throttle_brake_chart) {
                        Plotly.newPlot('throttleBrakeChart', charts.throttle_brake_chart.data, charts.throttle_brake_chart.layout, {responsive: true});
                        document.getElementById('throttleBrakeContainer').style.display = 'block';
                    }
                    
                    if (charts.rpm_gear_chart) {
                        Plotly.newPlot('rpmGearChart', charts.rpm_gear_chart.data, charts.rpm_gear_chart.layout, {responsive: true});
                        document.getElementById('rpmGearContainer').style.display = 'block';
                    }
                    
                    if (charts.drs_chart) {
                        Plotly.newPlot('drsChart', charts.drs_chart.data, charts.drs_chart.layout, {responsive: true});
                        document.getElementById('drsChartContainer').style.display = 'block';
                    }
                }
                
            } catch (error) {
                alert('Error loading telemetry charts: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadSectorAnalysis() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            try {
                const response = await fetch(`/api/sector-charts?year=${year}&grand_prix=${grandPrix}&session=${session}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.sector_chart) {
                    Plotly.newPlot('sectorChart', data.sector_chart.data, data.sector_chart.layout, {responsive: true});
                    document.getElementById('sectorChartContainer').style.display = 'block';
                }
                
            } catch (error) {
                alert('Error loading sector analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadLapEvolution() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            const params = new URLSearchParams({
                year: year,
                grand_prix: grandPrix,
                session: session
            });
            
            selectedDrivers.forEach(driver => params.append('drivers', driver));
            
            try {
                const response = await fetch(`/api/lap-evolution?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.lap_evolution_chart) {
                    Plotly.newPlot('lapEvolutionChart', data.lap_evolution_chart.data, data.lap_evolution_chart.layout, {responsive: true});
                    document.getElementById('lapEvolutionContainer').style.display = 'block';
                }
                
            } catch (error) {
                alert('Error loading lap evolution: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadPerformanceAnalysis() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            
            try {
                // Load overtaking analysis
                const overtakingResponse = await fetch(`/api/overtaking-analysis?year=${year}&grand_prix=${grandPrix}`);
                const overtakingData = await overtakingResponse.json();
                
                // Load fuel effect analysis
                const fuelResponse = await fetch(`/api/fuel-effect-analysis?year=${year}&grand_prix=${grandPrix}`);
                const fuelData = await fuelResponse.json();
                
                // Display the data
                document.getElementById('overtakingData').innerHTML = `<pre>${JSON.stringify(overtakingData, null, 2)}</pre>`;
                document.getElementById('fuelEffectData').innerHTML = `<pre>${JSON.stringify(fuelData, null, 2)}</pre>`;
                
                document.getElementById('performanceAnalysisContainer').style.display = 'flex';
                
            } catch (error) {
                alert('Error loading performance analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Auto-load demo data
        setTimeout(() => {
            loadTelemetryCharts();
        }, 2000);
    </script>
</body>
</html>