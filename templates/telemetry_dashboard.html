
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track.lytix - Telemetry Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        .selection-container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .selection-item {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .selection-item label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .selection-item select {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .selection-item select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        .selection-item select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--surface);
        }
        
        .selection-item .loading-indicator {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-red);
            display: none;
        }
        
        .selection-item.loading .loading-indicator {
            display: block;
        }
        
        .selection-step {
            border-left: 4px solid var(--border);
            padding-left: 1rem;
            transition: all 0.3s ease;
        }
        
        .selection-step.active {
            border-left-color: var(--primary-red);
        }
        
        .selection-step.completed {
            border-left-color: #28a745;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .step-number {
            background: var(--border);
            color: var(--text-secondary);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .selection-step.active .step-number {
            background: var(--primary-red);
            color: white;
        }
        
        .selection-step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .selection-progress {
            background: var(--surface);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), #ff6b6b);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .chart-placeholder {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
            margin: 2rem 0;
        }
        
        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-red);
        }
        
        .loading {
            color: var(--primary-red);
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #28a745;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .telemetry-tabs {
            display: flex;
            margin-bottom: 2rem;
            background: var(--surface);
            border-radius: 12px;
            padding: 0.5rem;
        }
        
        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: var(--primary-red);
            color: white;
        }
        
        .tab-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-summary {
            background: var(--background);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }
        
        .data-summary h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-red);
        }
        
        .data-summary .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-red);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, var(--background) 0%, #1a1a24 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh; margin: 0; padding: 0;">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span>Track.lytix</span>
            </a>
            
            <nav class="nav">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/docs" class="nav-link">Documentation</a>
                <a href="/telemetry" class="nav-link active">Telemetry</a>
                <a href="/analytics" class="nav-link">Analytics</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Hero Section -->
        <section class="hero">
            <h1>üèéÔ∏è Advanced Telemetry Analysis</h1>
            <p>Step-by-step telemetry data exploration with real-time Formula 1 insights and comprehensive driver performance analysis</p>
        </section>

        <!-- Selection Progress -->
        <section class="selection-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1: Select a year to begin telemetry analysis</div>
        </section>

        <!-- Selection Controls -->
        <section class="selection-container">
            <h2>üìä Telemetry Data Selection</h2>
            <div class="selection-grid">
                <!-- Step 1: Year Selection -->
                <div class="selection-step active" id="yearStep">
                    <div class="step-indicator">
                        <span class="step-number">1</span>
                        <span>Select Year</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-calendar"></i> Championship Year</label>
                        <select id="yearSelect">
                            <option value="">Choose Year...</option>
                            <option value="2024">2024 Season</option>
                            <option value="2023">2023 Season</option>
                            <option value="2022">2022 Season</option>
                            <option value="2021">2021 Season</option>
                            <option value="2020">2020 Season</option>
                            <option value="2019">2019 Season</option>
                            <option value="2018">2018 Season</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Grand Prix Selection -->
                <div class="selection-step" id="grandPrixStep">
                    <div class="step-indicator">
                        <span class="step-number">2</span>
                        <span>Select Grand Prix</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-map-marker-alt"></i> Grand Prix</label>
                        <select id="grandPrixSelect" disabled>
                            <option value="">First select a year...</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Session Selection -->
                <div class="selection-step" id="sessionStep">
                    <div class="step-indicator">
                        <span class="step-number">3</span>
                        <span>Select Session</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-clock"></i> Session Type</label>
                        <select id="sessionSelect" disabled>
                            <option value="">First select Grand Prix...</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Driver Selection -->
                <div class="selection-step" id="driverStep">
                    <div class="step-indicator">
                        <span class="step-number">4</span>
                        <span>Select Driver</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-user"></i> Driver</label>
                        <select id="driverSelect" disabled>
                            <option value="">First select session...</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Summary -->
            <div class="data-summary" id="dataSummary" style="display: none;">
                <h4>üìã Session Overview</h4>
                <div id="summaryContent"></div>
            </div>
            
            <div class="quick-actions">
                <button class="action-btn primary" id="loadTelemetryBtn" onclick="loadTelemetryData()" disabled>
                    <i class="fas fa-chart-line"></i>
                    Load Telemetry Data
                </button>
                <button class="action-btn" id="compareDriversBtn" onclick="loadDriverComparison()" disabled>
                    <i class="fas fa-users"></i>
                    Compare Drivers
                </button>
                <button class="action-btn" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
                <button class="action-btn" onclick="resetDashboard()">
                    <i class="fas fa-refresh"></i>
                    Reset Selection
                </button>
            </div>
        </section>

        <!-- Telemetry Tabs -->
        <div class="telemetry-tabs">
            <button class="tab-button active" onclick="switchTab('telemetry')" id="telemetryTabBtn">
                <i class="fas fa-tachometer-alt"></i> Telemetry Data
            </button>
            <button class="tab-button" onclick="switchTab('charts')" id="chartsTabBtn" disabled>
                <i class="fas fa-chart-line"></i> Interactive Charts
            </button>
            <button class="tab-button" onclick="switchTab('comparison')" id="comparisonTabBtn" disabled>
                <i class="fas fa-balance-scale"></i> Driver Comparison
            </button>
            <button class="tab-button" onclick="switchTab('analysis')" id="analysisTabBtn" disabled>
                <i class="fas fa-microscope"></i> Performance Analysis
            </button>
        </div>

        <!-- Tab Contents -->
        <div id="telemetryTab" class="tab-content active">
            <section class="api-section">
                <h2>üìä Telemetry Data Output</h2>
                <div class="api-response" id="telemetryOutput">
                    <p class="placeholder-text">üèÅ Complete the 4-step selection process above to view detailed telemetry analysis</p>
                </div>
            </section>
        </div>

        <div id="chartsTab" class="tab-content">
            <section class="chart-container">
                <h2>üöÄ Speed Analysis</h2>
                <div id="speedChart" class="chart-placeholder">
                    <i class="fas fa-tachometer-alt"></i>
                    <p>Speed telemetry chart will appear here after data selection</p>
                </div>
            </section>
            
            <section class="chart-container">
                <h2>üéõÔ∏è Throttle & Brake Analysis</h2>
                <div id="throttleBrakeChart" class="chart-placeholder">
                    <i class="fas fa-chart-area"></i>
                    <p>Throttle and brake telemetry chart will appear here after data selection</p>
                </div>
            </section>
            
            <section class="chart-container">
                <h2>‚öôÔ∏è RPM & Gear Analysis</h2>
                <div id="rpmGearChart" class="chart-placeholder">
                    <i class="fas fa-cogs"></i>
                    <p>RPM and gear telemetry chart will appear here after data selection</p>
                </div>
            </section>
        </div>

        <div id="comparisonTab" class="tab-content">
            <section class="api-section">
                <h2>üîÑ Driver Comparison Analysis</h2>
                <div class="api-response" id="comparisonOutput">
                    <p class="placeholder-text">Driver comparison analysis will appear here after completing selection</p>
                </div>
            </section>
        </div>

        <div id="analysisTab" class="tab-content">
            <section class="api-section">
                <h2>üî¨ Performance Analysis</h2>
                <div class="api-response" id="analysisOutput">
                    <p class="placeholder-text">Detailed performance analysis will appear here after completing selection</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Track.lytix</h3>
                <p>Advanced Formula 1 data analysis platform providing real-time insights, comprehensive telemetry analysis, and championship tracking with AI-powered intelligence.</p>
                <div class="social-links">
                    <a href="https://t.me/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-telegram"></i>
                        Telegram
                    </a>
                    <a href="https://discord.gg/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-discord"></i>
                        Discord
                    </a>
                    <a href="https://github.com/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-github"></i>
                        GitHub
                    </a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Telemetry Features</h3>
                <a href="#" class="footer-link">Speed Analysis</a>
                <a href="#" class="footer-link">Throttle & Brake Data</a>
                <a href="#" class="footer-link">RPM & Gear Tracking</a>
                <a href="#" class="footer-link">DRS Usage Patterns</a>
                <a href="#" class="footer-link">Sector Time Analysis</a>
                <a href="#" class="footer-link">Driver Comparisons</a>
            </div>
            
            <div class="footer-section">
                <h3>Data Visualization</h3>
                <a href="#" class="footer-link">Interactive Charts</a>
                <a href="#" class="footer-link">Real-time Updates</a>
                <a href="#" class="footer-link">Export Options</a>
                <a href="#" class="footer-link">Multi-driver View</a>
                <a href="#" class="footer-link">Session Analysis</a>
                <a href="#" class="footer-link">Performance Metrics</a>
            </div>
            
            <div class="footer-section">
                <h3>Technical Details</h3>
                <p><strong>Data Source:</strong> FastF1 Official API</p>
                <p><strong>Update Rate:</strong> Real-time</p>
                <p><strong>Precision:</strong> Millisecond accuracy</p>
                <p><strong>Coverage:</strong> All F1 sessions</p>
                <p><strong>Drivers:</strong> Complete grid (20)</p>
                <p><strong>Visualization:</strong> Plotly.js</p>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p>&copy; 2025 Track.lytix. Built With Nothing, Powered By DeepInk Team.</p>
                <div class="footer-tech">
                    <span>Real-time Telemetry</span>
                    <span>‚Ä¢</span>
                    <span>Interactive Charts</span>
                    <span>‚Ä¢</span>
                    <span>Performance Analysis</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let currentTelemetryData = null;
        let availableDrivers = [];
        let currentSelection = {
            year: null,
            grandPrix: null,
            session: null,
            driver: null
        };
        let sessionData = null;

        // Grand Prix options for different years
        const grandPrixByYear = {
            2024: ['Bahrain', 'Saudi Arabia', 'Australia', 'Japan', 'China', 'Miami', 'Emilia Romagna', 'Monaco', 'Canada', 'Spain', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Azerbaijan', 'Singapore', 'United States', 'Mexico', 'Brazil', 'Las Vegas', 'Qatar', 'Abu Dhabi'],
            2023: ['Bahrain', 'Saudi Arabia', 'Australia', 'Azerbaijan', 'Miami', 'Monaco', 'Spain', 'Canada', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Singapore', 'Japan', 'Qatar', 'United States', 'Mexico', 'Brazil', 'Las Vegas', 'Abu Dhabi'],
            2022: ['Bahrain', 'Saudi Arabia', 'Australia', 'Emilia Romagna', 'Miami', 'Spain', 'Monaco', 'Azerbaijan', 'Canada', 'Great Britain', 'Austria', 'France', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Singapore', 'Japan', 'United States', 'Mexico', 'Brazil', 'Abu Dhabi'],
            2021: ['Bahrain', 'Emilia Romagna', 'Portugal', 'Spain', 'Monaco', 'Azerbaijan', 'France', 'Styria', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Russia', 'Turkey', 'United States', 'Mexico', 'Brazil', 'Qatar', 'Saudi Arabia', 'Abu Dhabi'],
            2020: ['Austria', 'Styria', 'Hungary', 'Great Britain', '70th Anniversary', 'Spain', 'Belgium', 'Italy', 'Tuscany', 'Russia', 'Eifel', 'Portugal', 'Emilia Romagna', 'Turkey', 'Bahrain', 'Sakhir', 'Abu Dhabi'],
            2019: ['Australia', 'Bahrain', 'China', 'Azerbaijan', 'Spain', 'Monaco', 'Canada', 'France', 'Austria', 'Great Britain', 'Germany', 'Hungary', 'Belgium', 'Italy', 'Singapore', 'Russia', 'Japan', 'Mexico', 'United States', 'Brazil', 'Abu Dhabi'],
            2018: ['Australia', 'Bahrain', 'China', 'Azerbaijan', 'Spain', 'Monaco', 'Canada', 'France', 'Austria', 'Great Britain', 'Germany', 'Hungary', 'Belgium', 'Italy', 'Singapore', 'Russia', 'Japan', 'United States', 'Mexico', 'Brazil', 'Abu Dhabi']
        };

        const sessionTypes = ['Practice 1', 'Practice 2', 'Practice 3', 'Qualifying', 'Race'];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgress();
        });

        function setupEventListeners() {
            document.getElementById('yearSelect').addEventListener('change', onYearChange);
            document.getElementById('grandPrixSelect').addEventListener('change', onGrandPrixChange);
            document.getElementById('sessionSelect').addEventListener('change', onSessionChange);
            document.getElementById('driverSelect').addEventListener('change', onDriverChange);
        }

        function updateProgress() {
            const steps = ['year', 'grandPrix', 'session', 'driver'];
            let completedSteps = 0;
            
            steps.forEach((step, index) => {
                const stepElement = document.getElementById(step + 'Step');
                if (currentSelection[step]) {
                    stepElement.classList.add('completed');
                    stepElement.classList.remove('active');
                    completedSteps++;
                } else {
                    stepElement.classList.remove('completed');
                    if (index === completedSteps) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }
            });

            const progressPercent = (completedSteps / steps.length) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';
            
            const progressMessages = [
                'Step 1: Select a year to begin telemetry analysis',
                'Step 2: Choose a Grand Prix from the selected season',
                'Step 3: Select a session type for detailed analysis',
                'Step 4: Choose a driver to view their telemetry data',
                '‚úÖ All steps completed! Ready for telemetry analysis'
            ];
            
            document.getElementById('progressText').textContent = progressMessages[completedSteps];
            
            // Enable/disable action buttons
            const allStepsComplete = completedSteps === steps.length;
            document.getElementById('loadTelemetryBtn').disabled = !allStepsComplete;
            document.getElementById('compareDriversBtn').disabled = completedSteps < 3;
            
            // Enable/disable tabs
            ['chartsTabBtn', 'comparisonTabBtn', 'analysisTabBtn'].forEach(btnId => {
                document.getElementById(btnId).disabled = !allStepsComplete;
            });
        }

        async function onYearChange() {
            const year = document.getElementById('yearSelect').value;
            const yearStep = document.getElementById('yearStep');
            
            if (year) {
                yearStep.classList.add('loading');
                currentSelection.year = parseInt(year);
                
                // Reset subsequent selections
                resetSubsequentSelections(['grandPrix', 'session', 'driver']);
                
                // Populate Grand Prix dropdown
                await populateGrandPrixDropdown(year);
                
                yearStep.classList.remove('loading');
                document.getElementById('grandPrixSelect').disabled = false;
                
                showNotification(`‚úÖ Year ${year} selected. Choose a Grand Prix to continue.`, 'success');
            } else {
                currentSelection.year = null;
                resetSubsequentSelections(['grandPrix', 'session', 'driver']);
                document.getElementById('grandPrixSelect').disabled = true;
            }
            
            updateProgress();
        }

        async function populateGrandPrixDropdown(year) {
            const gpSelect = document.getElementById('grandPrixSelect');
            gpSelect.innerHTML = '<option value="">Choose Grand Prix...</option>';
            
            const grandPrixList = grandPrixByYear[year] || grandPrixByYear[2024];
            
            grandPrixList.forEach(gp => {
                const option = document.createElement('option');
                option.value = gp;
                option.textContent = gp + ' Grand Prix';
                gpSelect.appendChild(option);
            });
        }

        async function onGrandPrixChange() {
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const gpStep = document.getElementById('grandPrixStep');
            
            if (grandPrix) {
                gpStep.classList.add('loading');
                currentSelection.grandPrix = grandPrix;
                
                // Reset subsequent selections
                resetSubsequentSelections(['session', 'driver']);
                
                // Populate session dropdown
                await populateSessionDropdown();
                
                gpStep.classList.remove('loading');
                document.getElementById('sessionSelect').disabled = false;
                
                showNotification(`‚úÖ ${grandPrix} Grand Prix selected. Choose a session type.`, 'success');
            } else {
                currentSelection.grandPrix = null;
                resetSubsequentSelections(['session', 'driver']);
                document.getElementById('sessionSelect').disabled = true;
            }
            
            updateProgress();
        }

        async function populateSessionDropdown() {
            const sessionSelect = document.getElementById('sessionSelect');
            sessionSelect.innerHTML = '<option value="">Choose Session...</option>';
            
            sessionTypes.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                sessionSelect.appendChild(option);
            });
        }

        async function onSessionChange() {
            const session = document.getElementById('sessionSelect').value;
            const sessionStep = document.getElementById('sessionStep');
            
            if (session) {
                sessionStep.classList.add('loading');
                currentSelection.session = session;
                
                // Reset driver selection
                resetSubsequentSelections(['driver']);
                
                try {
                    // Load session data and available drivers
                    await loadSessionData();
                    await populateDriverDropdown();
                    
                    document.getElementById('driverSelect').disabled = false;
                    showNotification(`‚úÖ ${session} session selected. Choose a driver for analysis.`, 'success');
                } catch (error) {
                    showNotification(`‚ùå Error loading session data: ${error.message}`, 'error');
                    currentSelection.session = null;
                }
                
                sessionStep.classList.remove('loading');
            } else {
                currentSelection.session = null;
                resetSubsequentSelections(['driver']);
                document.getElementById('driverSelect').disabled = true;
            }
            
            updateProgress();
        }

        async function loadSessionData() {
            const { year, grandPrix, session } = currentSelection;
            
            const response = await fetch(`/api/session-data?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            sessionData = data;
            availableDrivers = data.drivers || [];
            
            // Update session summary
            updateSessionSummary(data);
        }

        function updateSessionSummary(data) {
            const summaryDiv = document.getElementById('dataSummary');
            const summaryContent = document.getElementById('summaryContent');
            
            summaryContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${availableDrivers.length}</div>
                        <div class="stat-label">Drivers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.laps_count || 0}</div>
                        <div class="stat-label">Total Laps</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${currentSelection.year}</div>
                        <div class="stat-label">Season</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${currentSelection.session}</div>
                        <div class="stat-label">Session</div>
                    </div>
                </div>
                <p><strong>Circuit:</strong> ${data.session_info?.circuit || currentSelection.grandPrix}</p>
                <p><strong>Date:</strong> ${data.session_info?.date || 'N/A'}</p>
            `;
            
            summaryDiv.style.display = 'block';
        }

        async function populateDriverDropdown() {
            const driverSelect = document.getElementById('driverSelect');
            driverSelect.innerHTML = '<option value="">Choose Driver...</option>';
            
            availableDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                option.textContent = driver;
                driverSelect.appendChild(option);
            });
        }

        function onDriverChange() {
            const driver = document.getElementById('driverSelect').value;
            
            if (driver) {
                currentSelection.driver = driver;
                showNotification(`üèéÔ∏è Driver ${driver} selected. Ready for telemetry analysis!`, 'success');
            } else {
                currentSelection.driver = null;
            }
            
            updateProgress();
        }

        function resetSubsequentSelections(selections) {
            selections.forEach(selection => {
                currentSelection[selection] = null;
                const selectElement = document.getElementById(selection + 'Select');
                selectElement.selectedIndex = 0;
                selectElement.disabled = true;
                
                if (selection === 'grandPrix') {
                    selectElement.innerHTML = '<option value="">First select a year...</option>';
                } else if (selection === 'session') {
                    selectElement.innerHTML = '<option value="">First select Grand Prix...</option>';
                } else if (selection === 'driver') {
                    selectElement.innerHTML = '<option value="">First select session...</option>';
                }
            });
            
            if (selections.includes('session')) {
                document.getElementById('dataSummary').style.display = 'none';
                sessionData = null;
                availableDrivers = [];
            }
        }

        async function loadTelemetryData() {
            const { year, grandPrix, session, driver } = currentSelection;
            
            if (!year || !grandPrix || !session || !driver) {
                showNotification('‚ùå Please complete all selection steps first', 'error');
                return;
            }
            
            const output = document.getElementById('telemetryOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading detailed telemetry data...</div>';
            
            try {
                const response = await fetch(`/api/telemetry?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&drivers=${driver}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentTelemetryData = data;
                displayTelemetryData(data);
                showNotification('‚úÖ Telemetry data loaded successfully!', 'success');
                
                // Enable chart tabs
                ['chartsTabBtn', 'comparisonTabBtn', 'analysisTabBtn'].forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });
                
            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading telemetry: ${error.message}</div>`;
                showNotification(`‚ùå Failed to load telemetry data: ${error.message}`, 'error');
            }
        }

        function displayTelemetryData(data) {
            const output = document.getElementById('telemetryOutput');
            const telemetryKeys = Object.keys(data.telemetry_data);
            
            if (telemetryKeys.length === 0) {
                output.innerHTML = '<div class="error">‚ùå No telemetry data available for the selected driver</div>';
                return;
            }
            
            const driver = telemetryKeys[0];
            const driverData = data.telemetry_data[driver];
            
            output.innerHTML = `
                <div class="response-content">
                    <div class="success">
                        <h3>‚úÖ Telemetry Data Loaded Successfully</h3>
                        <p>Driver: <strong>${driver}</strong> | Lap Time: <strong>${driverData.lap_time}</strong></p>
                    </div>
                    
                    <div class="data-summary">
                        <h4>üìä Telemetry Overview</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">${driverData.speed ? driverData.speed.length : 0}</div>
                                <div class="stat-label">Data Points</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.speed ? Math.max(...driverData.speed) : 0}</div>
                                <div class="stat-label">Max Speed (km/h)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.rpm ? Math.max(...driverData.rpm) : 0}</div>
                                <div class="stat-label">Max RPM</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.gear ? Math.max(...driverData.gear) : 0}</div>
                                <div class="stat-label">Max Gear</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="telemetry-data">
                        <h4>üîß Raw Telemetry Data</h4>
                        <p><em>Switch to "Interactive Charts" tab for visual analysis</em></p>
                        <details>
                            <summary>View Raw JSON Data</summary>
                            <pre><code>${JSON.stringify(data.telemetry_data, null, 2)}</code></pre>
                        </details>
                    </div>
                </div>
            `;
        }

        async function loadDriverComparison() {
            const { year, grandPrix, session } = currentSelection;
            
            if (!year || !grandPrix || !session) {
                showNotification('‚ùå Please select year, grand prix, and session first', 'error');
                return;
            }
            
            const output = document.getElementById('comparisonOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading driver comparison...</div>';
            
            try {
                // Load comparison for available drivers (limit to first 5 for performance)
                const drivers = availableDrivers.slice(0, 5);
                const driverParams = drivers.map(d => `drivers=${encodeURIComponent(d)}`).join('&');
                
                const response = await fetch(`/api/driver-comparison?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&${driverParams}`);
                const data = await response.json();
                
                output.innerHTML = `
                    <div class="response-content">
                        <h3>üîÑ Driver Comparison Analysis</h3>
                        <p><strong>Comparing:</strong> ${drivers.join(', ')}</p>
                        <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </div>
                `;
                
                showNotification('‚úÖ Driver comparison loaded successfully!', 'success');
                
            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading comparison: ${error.message}</div>`;
                showNotification(`‚ùå Failed to load driver comparison: ${error.message}`, 'error');
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load charts if switching to charts tab and we have data
            if (tabName === 'charts' && currentTelemetryData) {
                loadTelemetryCharts();
            }
        }

        async function loadTelemetryCharts() {
            const { year, grandPrix, session, driver } = currentSelection;
            
            if (!year || !grandPrix || !session || !driver) {
                return;
            }
            
            try {
                const response = await fetch(`/api/telemetry-charts?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&drivers=${driver}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display charts using Plotly
                if (data.telemetry_charts) {
                    if (data.telemetry_charts.speed_chart) {
                        Plotly.newPlot('speedChart', data.telemetry_charts.speed_chart.data, data.telemetry_charts.speed_chart.layout);
                    }
                    if (data.telemetry_charts.throttle_brake_chart) {
                        Plotly.newPlot('throttleBrakeChart', data.telemetry_charts.throttle_brake_chart.data, data.telemetry_charts.throttle_brake_chart.layout);
                    }
                    if (data.telemetry_charts.rpm_gear_chart) {
                        Plotly.newPlot('rpmGearChart', data.telemetry_charts.rpm_gear_chart.data, data.telemetry_charts.rpm_gear_chart.layout);
                    }
                }
                
            } catch (error) {
                console.error('Error loading telemetry charts:', error);
                showNotification(`‚ùå Error loading charts: ${error.message}`, 'error');
            }
        }

        function exportData() {
            if (currentTelemetryData) {
                const dataStr = JSON.stringify(currentTelemetryData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `telemetry_${currentSelection.year}_${currentSelection.grandPrix}_${currentSelection.session}_${currentSelection.driver}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('‚úÖ Telemetry data exported successfully!', 'success');
            } else {
                showNotification('‚ùå No telemetry data available to export', 'error');
            }
        }

        function resetDashboard() {
            // Reset all selections
            currentSelection = { year: null, grandPrix: null, session: null, driver: null };
            currentTelemetryData = null;
            sessionData = null;
            availableDrivers = [];
            
            // Reset all dropdowns
            document.getElementById('yearSelect').selectedIndex = 0;
            resetSubsequentSelections(['grandPrix', 'session', 'driver']);
            
            // Reset progress
            updateProgress();
            
            // Reset outputs
            document.getElementById('telemetryOutput').innerHTML = 
                '<p class="placeholder-text">üèÅ Complete the 4-step selection process above to view detailed telemetry analysis</p>';
            
            document.getElementById('comparisonOutput').innerHTML = 
                '<p class="placeholder-text">Driver comparison analysis will appear here after completing selection</p>';
            
            document.getElementById('analysisOutput').innerHTML = 
                '<p class="placeholder-text">Detailed performance analysis will appear here after completing selection</p>';
            
            // Clear charts
            document.getElementById('speedChart').innerHTML = '<i class="fas fa-tachometer-alt"></i><p>Speed telemetry chart will appear here after data selection</p>';
            document.getElementById('throttleBrakeChart').innerHTML = '<i class="fas fa-chart-area"></i><p>Throttle and brake telemetry chart will appear here after data selection</p>';
            document.getElementById('rpmGearChart').innerHTML = '<i class="fas fa-cogs"></i><p>RPM and gear telemetry chart will appear here after data selection</p>';
            
            // Hide summary
            document.getElementById('dataSummary').style.display = 'none';
            
            // Switch back to telemetry tab
            switchTab('telemetry');
            
            showNotification('üîÑ Dashboard reset successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#007bff';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Add CSS for notification animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
