<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Dashboard - Real-time Data Visualization</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        .chart-container {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border-radius: 15px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid #444;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
        }
        .control-panel {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #555;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            margin: 2rem 0;
        }
        .loading-spinner .spinner-border {
            width: 4rem;
            height: 4rem;
        }
        .driver-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .driver-badge {
            padding: 0.75rem 1.25rem;
            border-radius: 25px;
            border: 2px solid #444;
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .driver-badge.selected {
            background: linear-gradient(135deg, #dc3545 0%, #ff4757 100%);
            border-color: #dc3545;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }
        .driver-badge:hover {
            border-color: #dc3545;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }
        .quick-viz-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
            border: none;
            color: white;
            padding: 1rem 1.75rem;
            border-radius: 30px;
            margin: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3);
            position: relative;
            overflow: hidden;
        }
        .quick-viz-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.5);
        }
        .quick-viz-btn:active {
            transform: scale(0.98);
        }
        .quick-viz-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .quick-viz-btn:hover::before {
            left: 100%;
        }
        .session-info {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #ffd700;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #555;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }
        .chart-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .chart-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-racing-car text-danger"></i> F1 Analytics
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/telemetry">Telemetry</a>
                <a class="nav-link" href="/docs">API Docs</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-4 text-primary mb-3">
                <i class="fas fa-racing-car"></i> F1 Telemetry Dashboard
            </h1>
            <p class="lead text-muted mb-4">Advanced real-time telemetry data visualization and performance analysis</p>
            
            <!-- Live Session Info -->
            <div class="session-info">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="sessionStatus">READY</div>
                            <small class="text-muted">Session Status</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="driversCount">2</div>
                            <small class="text-muted">Selected Drivers</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="chartsLoaded">0</div>
                            <small class="text-muted">Charts Loaded</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value" id="lastUpdate">--:--</div>
                            <small class="text-muted">Last Update</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h4><i class="fas fa-sliders-h"></i> Session Configuration</h4>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Year</label>
                    <select class="form-select" id="yearSelect">
                        <option value="2025">2025</option>
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Grand Prix</label>
                    <select class="form-select" id="grandPrixSelect">
                        <option value="Bahrain" selected>Bahrain</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Australia">Australia</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="Miami">Miami</option>
                        <option value="Emilia Romagna">Emilia Romagna</option>
                        <option value="Monaco">Monaco</option>
                        <option value="Canada">Canada</option>
                        <option value="Spain">Spain</option>
                        <option value="Austria">Austria</option>
                        <option value="Great Britain">Great Britain</option>
                        <option value="Hungary">Hungary</option>
                        <option value="Belgium">Belgium</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Italy">Italy</option>
                        <option value="Singapore">Singapore</option>
                        <option value="United States">United States</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Las Vegas">Las Vegas</option>
                        <option value="Qatar">Qatar</option>
                        <option value="Abu Dhabi">Abu Dhabi</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Session</label>
                    <select class="form-select" id="sessionSelect">
                        <option value="Practice 1">Practice 1</option>
                        <option value="Practice 2">Practice 2</option>
                        <option value="Practice 3">Practice 3</option>
                        <option value="Qualifying">Qualifying</option>
                        <option value="Race" selected>Race</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Lap Type</label>
                    <select class="form-select" id="lapTypeSelect">
                        <option value="fastest" selected>Fastest Lap</option>
                        <option value="first">First Lap</option>
                    </select>
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">Select Drivers for Comparison (Max 4)</label>
                <div class="driver-selector" id="driverSelector">
                    <div class="driver-badge selected" data-driver="VER">VER</div>
                    <div class="driver-badge selected" data-driver="HAM">HAM</div>
                    <div class="driver-badge" data-driver="LEC">LEC</div>
                    <div class="driver-badge" data-driver="RUS">RUS</div>
                    <div class="driver-badge" data-driver="SAI">SAI</div>
                    <div class="driver-badge" data-driver="NOR">NOR</div>
                    <div class="driver-badge" data-driver="PIA">PIA</div>
                    <div class="driver-badge" data-driver="ALO">ALO</div>
                    <div class="driver-badge" data-driver="STR">STR</div>
                    <div class="driver-badge" data-driver="GAS">GAS</div>
                    <div class="driver-badge" data-driver="OCO">OCO</div>
                    <div class="driver-badge" data-driver="ALB">ALB</div>
                    <div class="driver-badge" data-driver="TSU">TSU</div>
                    <div class="driver-badge" data-driver="RIC">RIC</div>
                    <div class="driver-badge" data-driver="HUL">HUL</div>
                    <div class="driver-badge" data-driver="MAG">MAG</div>
                    <div class="driver-badge" data-driver="ZHO">ZHO</div>
                    <div class="driver-badge" data-driver="BOT">BOT</div>
                    <div class="driver-badge" data-driver="SAR">SAR</div>
                    <div class="driver-badge" data-driver="COL">COL</div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button class="quick-viz-btn" onclick="loadTelemetryCharts()">
                    <i class="fas fa-chart-area"></i> Load Telemetry Charts
                </button>
                <button class="quick-viz-btn" onclick="loadSectorAnalysis()">
                    <i class="fas fa-stopwatch"></i> Sector Analysis
                </button>
                <button class="quick-viz-btn" onclick="loadLapEvolution()">
                    <i class="fas fa-trending-up"></i> Lap Evolution
                </button>
                <button class="quick-viz-btn" onclick="loadPerformanceAnalysis()">
                    <i class="fas fa-cogs"></i> Performance Analysis
                </button>
                <button class="quick-viz-btn" onclick="loadAdvancedAnalytics()">
                    <i class="fas fa-analytics"></i> Advanced Analytics
                </button>
                <button class="quick-viz-btn" onclick="loadDriverComparison()">
                    <i class="fas fa-users"></i> Driver Comparison
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading F1 data and generating visualizations...</p>
        </div>

        <!-- Telemetry Charts -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container" id="speedChartContainer" style="display: none;">
                    <div class="chart-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Speed Comparison</h5>
                        <div class="chart-controls">
                            <button class="chart-btn" onclick="exportChart('speedChart')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="chart-btn" onclick="fullscreenChart('speedChart')">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="speedProgress"></div>
                    </div>
                    <div id="speedChart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container" id="throttleBrakeContainer" style="display: none;">
                    <div class="chart-header">
                        <h5><i class="fas fa-car"></i> Throttle & Brake Analysis</h5>
                        <div class="chart-controls">
                            <button class="chart-btn" onclick="exportChart('throttleBrakeChart')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="chart-btn" onclick="toggleChartType('throttleBrakeChart')">
                                <i class="fas fa-chart-area"></i> Toggle View
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="throttleBrakeProgress"></div>
                    </div>
                    <div id="throttleBrakeChart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container" id="rpmGearContainer" style="display: none;">
                    <div class="chart-header">
                        <h5><i class="fas fa-cog"></i> RPM & Gear Analysis</h5>
                        <div class="chart-controls">
                            <button class="chart-btn" onclick="exportChart('rpmGearChart')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="chart-btn" onclick="showStats('rpmGear')">
                                <i class="fas fa-chart-bar"></i> Stats
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="rpmGearProgress"></div>
                    </div>
                    <div id="rpmGearChart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container" id="sectorChartContainer" style="display: none;">
                    <h5><i class="fas fa-flag-checkered"></i> Sector Times</h5>
                    <div id="sectorChart"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container" id="lapEvolutionContainer" style="display: none;">
                    <h5><i class="fas fa-chart-line"></i> Lap Time Evolution</h5>
                    <div id="lapEvolutionChart"></div>
                </div>
            </div>
        </div>

        <!-- DRS Chart -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container" id="drsChartContainer" style="display: none;">
                    <div class="chart-header">
                        <h5><i class="fas fa-wind"></i> DRS Usage Analysis</h5>
                        <div class="chart-controls">
                            <button class="chart-btn" onclick="exportChart('drsChart')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="chart-btn" onclick="analyzeDRS()">
                                <i class="fas fa-analytics"></i> Analyze Zones
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="drsProgress"></div>
                    </div>
                    <div id="drsChart"></div>
                </div>
            </div>
        </div>

        <!-- Performance Analysis -->
        <div class="row" id="performanceAnalysisContainer" style="display: none;">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-exchange-alt"></i> Overtaking Analysis</h5>
                    <div id="overtakingData"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-gas-pump"></i> Fuel Effect Analysis</h5>
                    <div id="fuelEffectData"></div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics -->
        <div class="row" id="advancedAnalyticsContainer" style="display: none;">
            <div class="col-md-4">
                <div class="chart-container">
                    <h5><i class="fas fa-tire"></i> Tyre Performance</h5>
                    <div id="tyreAnalysisData"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <h5><i class="fas fa-cloud-sun"></i> Weather Impact</h5>
                    <div id="weatherAnalysisData"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <h5><i class="fas fa-road"></i> Track Analysis</h5>
                    <div id="trackAnalysisData"></div>
                </div>
            </div>
        </div>

        <!-- Driver Comparison -->
        <div class="row" id="driverComparisonContainer" style="display: none;">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-users"></i> Comprehensive Driver Comparison</h5>
                    <div id="driverComparisonData"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedDrivers = ['VER', 'HAM'];
        let loadedCharts = 0;
        let sessionData = null;

        // Driver selection functionality
        document.addEventListener('DOMContentLoaded', function() {
            const driverBadges = document.querySelectorAll('.driver-badge');
            
            driverBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    const driver = this.dataset.driver;
                    
                    if (this.classList.contains('selected')) {
                        if (selectedDrivers.length > 1) {  // Keep at least one driver selected
                            this.classList.remove('selected');
                            selectedDrivers = selectedDrivers.filter(d => d !== driver);
                        }
                    } else {
                        if (selectedDrivers.length < 4) {  // Limit to 4 drivers for readability
                            this.classList.add('selected');
                            selectedDrivers.push(driver);
                        }
                    }
                    
                    updateDriverCount();
                    animateDriverSelection(this);
                });
            });
            
            updateLastUpdate();
            setInterval(updateLastUpdate, 30000); // Update every 30 seconds
        });

        // Enhanced UI functions
        function updateDriverCount() {
            document.getElementById('driversCount').textContent = selectedDrivers.length;
        }

        function updateChartsLoaded() {
            document.getElementById('chartsLoaded').textContent = loadedCharts;
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString().substring(0, 5);
        }

        function updateSessionStatus(status) {
            document.getElementById('sessionStatus').textContent = status;
        }

        function animateDriverSelection(element) {
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = '';
            }, 200);
        }

        function updateProgress(chartId, progress) {
            const progressBar = document.getElementById(chartId + 'Progress');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        // Chart utility functions
        function exportChart(chartId) {
            try {
                const chart = document.getElementById(chartId);
                Plotly.downloadImage(chart, {
                    format: 'png',
                    width: 1200,
                    height: 800,
                    filename: `f1_telemetry_${chartId}_${new Date().toISOString().split('T')[0]}`
                });
            } catch (error) {
                alert('Export feature not available for this chart');
            }
        }

        function fullscreenChart(chartId) {
            const chart = document.getElementById(chartId);
            if (chart.requestFullscreen) {
                chart.requestFullscreen();
            } else if (chart.webkitRequestFullscreen) {
                chart.webkitRequestFullscreen();
            }
        }

        function toggleChartType(chartId) {
            // Placeholder for chart type toggling
            console.log('Toggle chart type for:', chartId);
        }

        function showStats(chartType) {
            alert(`Statistics for ${chartType} analysis will be implemented in the next update.`);
        }

        function analyzeDRS() {
            alert('DRS zone analysis feature coming soon!');
        }

        // Loading management
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            updateSessionStatus('LOADING');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
            updateSessionStatus('READY');
            updateLastUpdate();
        }

        function showChartLoading(chartId) {
            updateProgress(chartId, 0);
            setTimeout(() => updateProgress(chartId, 30), 100);
            setTimeout(() => updateProgress(chartId, 60), 300);
            setTimeout(() => updateProgress(chartId, 90), 500);
        }

        function hideChartLoading(chartId) {
            updateProgress(chartId, 100);
            setTimeout(() => {
                const progressBar = document.getElementById(chartId + 'Progress');
                if (progressBar && progressBar.parentElement) {
                    progressBar.parentElement.style.display = 'none';
                }
            }, 500);
        }

        function hideAllCharts() {
            const containers = ['speedChartContainer', 'throttleBrakeContainer', 'rpmGearContainer', 
                              'sectorChartContainer', 'lapEvolutionContainer', 'drsChartContainer', 
                              'performanceAnalysisContainer', 'advancedAnalyticsContainer', 'driverComparisonContainer'];
            containers.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }

        // API call functions
        async function loadTelemetryCharts() {
            showLoading();
            hideAllCharts();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            const lapType = document.getElementById('lapTypeSelect').value;
            
            const params = new URLSearchParams({
                year: year,
                grand_prix: grandPrix,
                session: session,
                lap_type: lapType
            });
            
            selectedDrivers.forEach(driver => params.append('drivers', driver));
            
            try {
                const response = await fetch(`/api/telemetry-charts?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Display charts
                if (data.telemetry_charts) {
                    const charts = data.telemetry_charts;
                    loadedCharts = 0;
                    
                    if (charts.speed_chart) {
                        showChartLoading('speed');
                        setTimeout(() => {
                            Plotly.newPlot('speedChart', charts.speed_chart.data, charts.speed_chart.layout, {
                                responsive: true,
                                displayModeBar: true,
                                modeBarButtonsToRemove: ['pan2d', 'lasso2d']
                            });
                            document.getElementById('speedChartContainer').style.display = 'block';
                            hideChartLoading('speed');
                            loadedCharts++;
                            updateChartsLoaded();
                        }, 500);
                    }
                    
                    if (charts.throttle_brake_chart) {
                        showChartLoading('throttleBrake');
                        setTimeout(() => {
                            Plotly.newPlot('throttleBrakeChart', charts.throttle_brake_chart.data, charts.throttle_brake_chart.layout, {
                                responsive: true,
                                displayModeBar: true
                            });
                            document.getElementById('throttleBrakeContainer').style.display = 'block';
                            hideChartLoading('throttleBrake');
                            loadedCharts++;
                            updateChartsLoaded();
                        }, 700);
                    }
                    
                    if (charts.rpm_gear_chart) {
                        showChartLoading('rpmGear');
                        setTimeout(() => {
                            Plotly.newPlot('rpmGearChart', charts.rpm_gear_chart.data, charts.rpm_gear_chart.layout, {
                                responsive: true,
                                displayModeBar: true
                            });
                            document.getElementById('rpmGearContainer').style.display = 'block';
                            hideChartLoading('rpmGear');
                            loadedCharts++;
                            updateChartsLoaded();
                        }, 900);
                    }
                    
                    if (charts.drs_chart) {
                        showChartLoading('drs');
                        setTimeout(() => {
                            Plotly.newPlot('drsChart', charts.drs_chart.data, charts.drs_chart.layout, {
                                responsive: true,
                                displayModeBar: true
                            });
                            document.getElementById('drsChartContainer').style.display = 'block';
                            hideChartLoading('drs');
                            loadedCharts++;
                            updateChartsLoaded();
                        }, 1100);
                    }
                    
                    // Store session data for future use
                    sessionData = data.session_info;
                }
                
            } catch (error) {
                alert('Error loading telemetry charts: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadSectorAnalysis() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            try {
                const response = await fetch(`/api/sector-charts?year=${year}&grand_prix=${grandPrix}&session=${session}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.sector_chart) {
                    Plotly.newPlot('sectorChart', data.sector_chart.data, data.sector_chart.layout, {responsive: true});
                    document.getElementById('sectorChartContainer').style.display = 'block';
                }
                
            } catch (error) {
                alert('Error loading sector analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadLapEvolution() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            const params = new URLSearchParams({
                year: year,
                grand_prix: grandPrix,
                session: session
            });
            
            selectedDrivers.forEach(driver => params.append('drivers', driver));
            
            try {
                const response = await fetch(`/api/lap-evolution?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.lap_evolution_chart) {
                    Plotly.newPlot('lapEvolutionChart', data.lap_evolution_chart.data, data.lap_evolution_chart.layout, {responsive: true});
                    document.getElementById('lapEvolutionContainer').style.display = 'block';
                }
                
            } catch (error) {
                alert('Error loading lap evolution: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadPerformanceAnalysis() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            
            try {
                // Load overtaking analysis
                const overtakingResponse = await fetch(`/api/overtaking-analysis?year=${year}&grand_prix=${grandPrix}`);
                const overtakingData = await overtakingResponse.json();
                
                // Load fuel effect analysis
                const fuelResponse = await fetch(`/api/fuel-effect-analysis?year=${year}&grand_prix=${grandPrix}`);
                const fuelData = await fuelResponse.json();
                
                // Display the data
                document.getElementById('overtakingData').innerHTML = `<pre>${JSON.stringify(overtakingData, null, 2)}</pre>`;
                document.getElementById('fuelEffectData').innerHTML = `<pre>${JSON.stringify(fuelData, null, 2)}</pre>`;
                
                document.getElementById('performanceAnalysisContainer').style.display = 'flex';
                
            } catch (error) {
                alert('Error loading performance analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadAdvancedAnalytics() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            try {
                // Load tyre analysis
                const tyreResponse = await fetch(`/api/tyre-analysis?year=${year}&grand_prix=${grandPrix}&session=${session}`);
                const tyreData = await tyreResponse.json();
                
                // Load weather analysis
                const weatherResponse = await fetch(`/api/weather-analysis?year=${year}&grand_prix=${grandPrix}&session=${session}`);
                const weatherData = await weatherResponse.json();
                
                // Load track characteristics
                const trackResponse = await fetch(`/api/track-characteristics?year=${year}&grand_prix=${grandPrix}&session=${session}`);
                const trackData = await trackResponse.json();
                
                // Display the data
                document.getElementById('tyreAnalysisData').innerHTML = `<pre>${JSON.stringify(tyreData, null, 2)}</pre>`;
                document.getElementById('weatherAnalysisData').innerHTML = `<pre>${JSON.stringify(weatherData, null, 2)}</pre>`;
                document.getElementById('trackAnalysisData').innerHTML = `<pre>${JSON.stringify(trackData, null, 2)}</pre>`;
                
                document.getElementById('advancedAnalyticsContainer').style.display = 'flex';
                
            } catch (error) {
                alert('Error loading advanced analytics: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadDriverComparison() {
            showLoading();
            
            const year = document.getElementById('yearSelect').value;
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const session = document.getElementById('sessionSelect').value;
            
            const params = new URLSearchParams({
                year: year,
                grand_prix: grandPrix,
                session: session
            });
            
            selectedDrivers.forEach(driver => params.append('drivers', driver));
            
            try {
                const response = await fetch(`/api/driver-comparison?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Create a formatted display for driver comparison
                let comparisonHtml = '<div class="row">';
                
                if (data.driver_comparison && data.driver_comparison.comparative_analysis) {
                    const analysis = data.driver_comparison.comparative_analysis;
                    
                    comparisonHtml += `
                        <div class="col-12 mb-3">
                            <h6>Performance Summary</h6>
                            <p><strong>Fastest Driver:</strong> ${analysis.fastest_driver || 'N/A'}</p>
                            <p><strong>Most Consistent:</strong> ${analysis.most_consistent_driver || 'N/A'}</p>
                        </div>
                    `;
                    
                    if (analysis.overall_rankings) {
                        comparisonHtml += `
                            <div class="col-md-6">
                                <h6>Speed Ranking</h6>
                                <ol>
                                    ${(analysis.overall_rankings.speed_ranking || []).map(driver => `<li>${driver}</li>`).join('')}
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>Consistency Ranking</h6>
                                <ol>
                                    ${(analysis.overall_rankings.consistency_ranking || []).map(driver => `<li>${driver}</li>`).join('')}
                                </ol>
                            </div>
                        `;
                    }
                }
                
                comparisonHtml += '</div>';
                comparisonHtml += `<div class="mt-3"><h6>Full Data</h6><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
                
                document.getElementById('driverComparisonData').innerHTML = comparisonHtml;
                document.getElementById('driverComparisonContainer').style.display = 'block';
                
            } catch (error) {
                alert('Error loading driver comparison: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Auto-load demo data
        setTimeout(() => {
            loadTelemetryCharts();
        }, 2000);
    </script>
</body>
</html>