<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track.lytix - Telemetry & Analytics Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .selection-container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .selection-item {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .selection-item label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .selection-item select {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .selection-item select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .selection-item select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--surface);
        }

        .selection-item .loading-indicator {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-red);
            display: none;
        }

        .selection-item.loading .loading-indicator {
            display: block;
        }

        .selection-step {
            border-left: 4px solid var(--border);
            padding-left: 1rem;
            transition: all 0.3s ease;
        }

        .selection-step.active {
            border-left-color: var(--primary-red);
        }

        .selection-step.completed {
            border-left-color: #28a745;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .step-number {
            background: var(--border);
            color: var(--text-secondary);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .selection-step.active .step-number {
            background: var(--primary-red);
            color: white;
        }

        .selection-step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .selection-progress {
            background: var(--surface);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), #ff6b6b);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .chart-placeholder {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
            margin: 2rem 0;
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-red);
        }

        .loading {
            color: var(--primary-red);
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
        }

        .error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #28a745;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .telemetry-tabs {
            display: flex;
            margin-bottom: 2rem;
            background: var(--surface);
            border-radius: 12px;
            padding: 0.5rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--primary-red);
            color: white;
        }

        .tab-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-summary {
            background: var(--background);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .data-summary h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-red);
        }

        .data-summary .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-red);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .analysis-type-btn {
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .analysis-type-btn:hover {
            border-color: var(--primary-red);
            color: var(--text-primary);
        }

        .analysis-type-btn.active {
            background: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
        }

        .comparison-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .driver-badge {
            background: var(--primary-red);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .driver-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .driver-telemetry-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .driver-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .driver-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        .comparison-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-item {
            background: var(--background);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-red);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .winner-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .telemetry-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .telemetry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .telemetry-title {
            color: var(--primary-red);
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .telemetry-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .analytic-item {
            background: var(--background);
            padding: 1.25rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .analytic-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-red);
            margin-bottom: 0.5rem;
        }

        .analytic-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .raw-data-section {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .raw-data-title {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, var(--background) 0%, #1a1a24 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh; margin: 0; padding: 0;">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span>Track.lytix</span>
            </a>

            <nav class="nav">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/docs" class="nav-link">Documentation</a>
                <a href="/telemetry" class="nav-link active">Telemetry & Analytics</a>
                <a href="/about" class="nav-link">About</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Hero Section -->
        <section class="hero">
            <h1>üèéÔ∏è Advanced Telemetry Analysis</h1>
            <p>Step-by-step telemetry data exploration with real-time Formula 1 insights and comprehensive driver performance analysis</p>
        </section>

        <!-- Selection Progress -->
        <section class="selection-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1: Select a year to begin telemetry analysis</div>
        </section>

        <!-- Selection Controls -->
        <section class="selection-container">
            <h2>üìä Telemetry Data Selection</h2>
            <div class="selection-grid">
                <!-- Step 1: Year Selection -->
                <div class="selection-step active" id="yearStep">
                    <div class="step-indicator">
                        <span class="step-number">1</span>
                        <span>Select Year</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-calendar"></i> Championship Year</label>
                        <select id="yearSelect">
                            <option value="">Choose Year...</option>
                            <option value="2025">2025 Season</option>
                            <option value="2024">2024 Season</option>
                            <option value="2023">2023 Season</option>
                            <option value="2022">2022 Season</option>
                            <option value="2021">2021 Season</option>
                            <option value="2020">2020 Season</option>
                            <option value="2019">2019 Season</option>
                            <option value="2018">2018 Season</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Grand Prix Selection -->
                <div class="selection-step" id="grandPrixStep">
                    <div class="step-indicator">
                        <span class="step-number">2</span>
                        <span>Select Grand Prix</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-map-marker-alt"></i> Grand Prix</label>
                        <select id="grandPrixSelect" disabled>
                            <option value="">First select a year...</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Session Selection -->
                <div class="selection-step" id="sessionStep">
                    <div class="step-indicator">
                        <span class="step-number">3</span>
                        <span>Select Session</span>
                    </div>
                    <div class="selection-item">
                        <label><i class="fas fa-clock"></i> Session Type</label>
                        <select id="sessionSelect" disabled>
                            <option value="">First select Grand Prix...</option>
                        </select>
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Driver Selection -->
                <div class="selection-step" id="driverStep">
                    <div class="step-indicator">
                        <span class="step-number">4</span>
                        <span>Select Drivers</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="selection-item">
                            <label><i class="fas fa-user"></i> Driver 1</label>
                            <select id="driver1Select" disabled>
                                <option value="">First select session...</option>
                            </select>
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="selection-item">
                            <label><i class="fas fa-user"></i> Driver 2</label>
                            <select id="driver2Select" disabled>
                                <option value="">First select session...</option>
                            </select>
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Summary -->
            <div class="data-summary" id="dataSummary" style="display: none;">
                <h4>üìã Session Overview</h4>
                <div id="summaryContent"></div>
            </div>

            <div class="quick-actions">
                <button class="action-btn primary" id="loadTelemetryBtn" onclick="loadTelemetryData()" disabled>
                    <i class="fas fa-chart-line"></i>
                    Load Telemetry Data
                </button>
                <button class="action-btn" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
                <button class="action-btn" onclick="resetDashboard()">
                    <i class="fas fa-refresh"></i>
                    Reset Selection
                </button>
            </div>
        </section>

        <!-- Telemetry Tabs -->
        <div class="telemetry-tabs">
            <button class="tab-button active" onclick="switchTab('telemetry')" id="telemetryTabBtn">
                <i class="fas fa-tachometer-alt"></i> Telemetry Data
            </button>
            <button class="tab-button" onclick="switchTab('charts')" id="chartsTabBtn" disabled>
                <i class="fas fa-chart-line"></i> Interactive Charts
            </button>
            <button class="tab-button" onclick="switchTab('comparison')" id="comparisonTabBtn" disabled>
                <i class="fas fa-balance-scale"></i> Driver Comparison
            </button>
            <button class="tab-button" onclick="switchTab('analysis')" id="analysisTabBtn" disabled>
                <i class="fas fa-microscope"></i> Performance Analysis
            </button>
        </div>

        <!-- Tab Contents -->
        <div id="telemetryTab" class="tab-content active">
            <section class="api-section">
                <h2>üìä Enhanced Telemetry Overview</h2>
                <div class="telemetry-overview" id="telemetryOverview" style="display: none;">
                    <div class="driver-comparison-container">
                        <div class="driver-telemetry-card" id="driver1Card">
                            <div class="driver-header">
                                <h3 id="driver1Name">Driver 1</h3>
                                <div class="driver-badge" id="driver1Badge">-</div>
                            </div>
                            <div class="telemetry-analytics" id="driver1Analytics">
                                <!-- Driver 1 analytics will be populated here -->
                            </div>
                        </div>
                        
                        <div class="driver-telemetry-card" id="driver2Card">
                            <div class="driver-header">
                                <h3 id="driver2Name">Driver 2</h3>
                                <div class="driver-badge" id="driver2Badge">-</div>
                            </div>
                            <div class="telemetry-analytics" id="driver2Analytics">
                                <!-- Driver 2 analytics will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="api-response" id="telemetryOutput">
                    <p class="placeholder-text">üèÅ Complete the 4-step selection process above to view detailed telemetry analysis for both selected drivers</p>
                </div>
            </section>
        </div>

        <div id="chartsTab" class="tab-content">
            <section class="chart-container">
                <h2>üöÄ Speed Analysis</h2>
                <div id="speedChart" class="chart-placeholder">
                    <i class="fas fa-tachometer-alt"></i>
                    <p>Speed telemetry chart will appear here after data selection</p>
                </div>
            </section>

            <section class="chart-container">
                <h2>üéõÔ∏è Throttle & Brake Analysis</h2>
                <div id="throttleBrakeChart" class="chart-placeholder">
                    <i class="fas fa-chart-area"></i>
                    <p>Throttle and brake telemetry chart will appear here after data selection</p>
                </div>
            </section>

            <section class="chart-container">
                <h2>‚öôÔ∏è RPM & Gear Analysis</h2>
                <div id="rpmGearChart" class="chart-placeholder">
                    <i class="fas fa-cogs"></i>
                    <p>RPM and gear telemetry chart will appear here after data selection</p>
                </div>
            </section>
        </div>

        <div id="comparisonTab" class="tab-content">
            <section class="api-section">
                <h2>üîÑ Driver Comparison Analysis</h2>

                <!-- Driver Selection Controls -->
                <div class="comparison-controls" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary-red);">Select Drivers to Compare</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Driver 1:</label>
                            <select id="comparisonDriver1" style="width: 100%; padding: 0.75rem; background: var(--background); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <option value="">Select first driver...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Driver 2:</label>
                            <select id="comparisonDriver2" style="width: 100%; padding: 0.75rem; background: var(--background); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <option value="">Select second driver...</option>
                            </select>
                        </div>
                    </div>
                    <button id="compareDriversBtn2" onclick="performDriverComparison()" style="margin-top: 1rem; background: var(--primary-red); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;" disabled>
                        <i class="fas fa-balance-scale"></i> Compare Drivers
                    </button>
                </div>

                <div class="api-response" id="comparisonOutput">
                    <p class="placeholder-text">Select two drivers and complete the session selection to view detailed comparison analysis</p>
                </div>
            </section>
        </div>

        <div id="analysisTab" class="tab-content">
            <section class="api-section">
                <h2>üî¨ Advanced Performance Analysis</h2>

                <!-- Analysis Type Selection -->
                <div class="analysis-controls" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary-red);">Analysis Type</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="analysis-type-btn active" onclick="selectAnalysisType('comprehensive')" data-type="comprehensive">
                            <i class="fas fa-chart-line"></i> Comprehensive Analysis
                        </button>
                        <button class="analysis-type-btn" onclick="selectAnalysisType('sector')" data-type="sector">
                            <i class="fas fa-stopwatch"></i> Sector Analysis
                        </button>
                        <button class="analysis-type-btn" onclick="selectAnalysisType('consistency')" data-type="consistency">
                            <i class="fas fa-heartbeat"></i> Consistency Metrics
                        </button>
                        <button class="analysis-type-btn" onclick="selectAnalysisType('cornering')" data-type="cornering">
                            <i class="fas fa-route"></i> Cornering Analysis
                        </button>
                    </div>
                    <button id="loadAnalysisBtn" onclick="loadPerformanceAnalysis()" style="margin-top: 1rem; background: var(--primary-red); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;" disabled>
                        <i class="fas fa-microscope"></i> Load Analysis
                    </button>
                </div>

                <div class="api-response" id="analysisOutput">
                    <p class="placeholder-text">Complete the selection process and choose an analysis type to view detailed performance insights</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Track.lytix</h3>
                <p>Advanced Formula 1 data analysis platform providing real-time insights, comprehensive telemetry analysis, and championship tracking with AI-powered intelligence.</p>
                <div class="social-links">
                    <a href="https://t.me/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-telegram"></i>
                        Telegram
                    </a>
                    <a href="https://discord.gg/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-discord"></i>
                        Discord
                    </a>
                    <a href="https://github.com/tracklytix" class="social-link" target="_blank" rel="noopener">
                        <i class="fab fa-github"></i>
                        GitHub
                    </a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Telemetry Features</h3>
                <a href="#" class="footer-link">Speed Analysis</a>
                <a href="#" class="footer-link">Throttle & Brake Data</a>
                <a href="#" class="footer-link">RPM & Gear Tracking</a>
                <a href="#" class="footer-link">DRS Usage Patterns</a>
                <a href="#" class="footer-link">Sector Time Analysis</a>
                <a href="#" class="footer-link">Driver Comparisons</a>
            </div>

            <div class="footer-section">
                <h3>Data Visualization</h3>
                <a href="#" class="footer-link">Interactive Charts</a>
                <a href="#" class="footer-link">Real-time Updates</a>
                <a href="#" class="footer-link">Export Options</a>
                <a href="#" class="footer-link">Multi-driver View</a>
                <a href="#" class="footer-link">Session Analysis</a>
                <a href="#" class="footer-link">Performance Metrics</a>
            </div>

            <div class="footer-section">
                <h3>Technical Details</h3>
                <p><strong>Data Source:</strong> FastF1 Official API</p>
                <p><strong>Update Rate:</strong> Real-time</p>
                <p><strong>Precision:</strong> Millisecond accuracy</p>
                <p><strong>Coverage:</strong> All F1 sessions</p>
                <p><strong>Drivers:</strong> Complete grid (20)</p>
                <p><strong>Visualization:</strong> Plotly.js</p>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p>&copy; 2025 Track.lytix. Built With Nothing, Powered By DeepInk Team.</p>
                <div class="footer-tech">
                    <span>Real-time Telemetry</span>
                    <span>‚Ä¢</span>
                    <span>Interactive Charts</span>
                    <span>‚Ä¢</span>
                    <span>Performance Analysis</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let currentTelemetryData = null;
        let availableDrivers = [];
        let currentSelection = {
            year: null,
            grandPrix: null,
            session: null,
            driver1: null,
            driver2: null
        };
        let sessionData = null;

        // Grand Prix options for different years
        const grandPrixByYear = {
            2025: ['Bahrain', 'Saudi Arabia', 'Australia', 'Japan', 'China', 'Miami', 'Emilia Romagna', 'Monaco', 'Canada', 'Spain', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Azerbaijan', 'Singapore', 'United States', 'Mexico', 'Brazil', 'Las Vegas', 'Qatar', 'Abu Dhabi'],
            2024: ['Bahrain', 'Saudi Arabia', 'Australia', 'Japan', 'China', 'Miami', 'Emilia Romagna', 'Monaco', 'Canada', 'Spain', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Azerbaijan', 'Singapore', 'United States', 'Mexico', 'Brazil', 'Las Vegas', 'Qatar', 'Abu Dhabi'],
            2023: ['Bahrain', 'Saudi Arabia', 'Australia', 'Azerbaijan', 'Miami', 'Monaco', 'Spain', 'Canada', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Singapore', 'Japan', 'Qatar', 'United States', 'Mexico', 'Brazil', 'Las Vegas', 'Abu Dhabi'],
            2022: ['Bahrain', 'Saudi Arabia', 'Australia', 'Emilia Romagna', 'Miami', 'Spain', 'Monaco', 'Azerbaijan', 'Canada', 'Great Britain', 'Austria', 'France', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Singapore', 'Japan', 'United States', 'Mexico', 'Brazil', 'Abu Dhabi'],
            2021: ['Bahrain', 'Emilia Romagna', 'Portugal', 'Spain', 'Monaco', 'Azerbaijan', 'France', 'Styria', 'Austria', 'Great Britain', 'Hungary', 'Belgium', 'Netherlands', 'Italy', 'Russia', 'Turkey', 'United States', 'Mexico', 'Brazil', 'Qatar', 'Saudi Arabia', 'Abu Dhabi'],
            2020: ['Austria', 'Styria', 'Hungary', 'Great Britain', '70th Anniversary', 'Spain', 'Belgium', 'Italy', 'Tuscany', 'Russia', 'Eifel', 'Portugal', 'Emilia Romagna', 'Turkey', 'Bahrain', 'Sakhir', 'Abu Dhabi'],
            2019: ['Australia', 'Bahrain', 'China', 'Azerbaijan', 'Spain', 'Monaco', 'Canada', 'France', 'Austria', 'Great Britain', 'Germany', 'Hungary', 'Belgium', 'Italy', 'Singapore', 'Russia', 'Japan', 'Mexico', 'United States', 'Brazil', 'Abu Dhabi'],
            2018: ['Australia', 'Bahrain', 'China', 'Azerbaijan', 'Spain', 'Monaco', 'Canada', 'France', 'Austria', 'Great Britain', 'Germany', 'Hungary', 'Belgium', 'Italy', 'Singapore', 'Russia', 'Japan', 'United States', 'Mexico', 'Brazil', 'Abu Dhabi']
        };

        const sessionTypes = ['Practice 1', 'Practice 2', 'Practice 3', 'Qualifying', 'Race'];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgress();
        });

        function setupEventListeners() {
            document.getElementById('yearSelect').addEventListener('change', onYearChange);
            document.getElementById('grandPrixSelect').addEventListener('change', onGrandPrixChange);
            document.getElementById('sessionSelect').addEventListener('change', onSessionChange);
            document.getElementById('driver1Select').addEventListener('change', onDriver1Change);
            document.getElementById('driver2Select').addEventListener('change', onDriver2Change);
        }

        function updateProgress() {
            const steps = ['year', 'grandPrix', 'session', 'driver'];
            let completedSteps = 0;

            steps.forEach((step, index) => {
                const stepElement = document.getElementById(step + 'Step');
                if (currentSelection[step]) {
                    stepElement.classList.add('completed');
                    stepElement.classList.remove('active');
                    completedSteps++;
                } else {
                    stepElement.classList.remove('completed');
                    if (index === completedSteps) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }
            });

            const progressPercent = (completedSteps / steps.length) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';

            const progressMessages = [
                'Step 1: Select a year to begin telemetry analysis',
                'Step 2: Choose a Grand Prix from the selected season',
                'Step 3: Select a session type for detailed analysis',
                'Step 4: Choose a driver to view their telemetry data',
                '‚úÖ All steps completed! Ready for telemetry analysis'
            ];

            document.getElementById('progressText').textContent = progressMessages[completedSteps];

            // Enable/disable action buttons
            const allStepsComplete = completedSteps === steps.length;
            document.getElementById('loadTelemetryBtn').disabled = !allStepsComplete;
            document.getElementById('compareDriversBtn').disabled = completedSteps < 3;

            // Enable/disable tabs
            ['chartsTabBtn', 'comparisonTabBtn', 'analysisTabBtn'].forEach(btnId => {
                document.getElementById(btnId).disabled = !allStepsComplete;
            });
        }

        async function onYearChange() {
            const year = document.getElementById('yearSelect').value;
            const yearStep = document.getElementById('yearStep');

            if (year) {
                yearStep.classList.add('loading');
                currentSelection.year = parseInt(year);

                // Reset subsequent selections
                resetSubsequentSelections(['grandPrix', 'session', 'driver']);

                // Populate Grand Prix dropdown
                await populateGrandPrixDropdown(year);

                yearStep.classList.remove('loading');
                document.getElementById('grandPrixSelect').disabled = false;

                showNotification(`‚úÖ Year ${year} selected. Choose a Grand Prix to continue.`, 'success');
            } else {
                currentSelection.year = null;
                resetSubsequentSelections(['grandPrix', 'session', 'driver']);
                document.getElementById('grandPrixSelect').disabled = true;
            }

            updateProgress();
        }

        async function populateGrandPrixDropdown(year) {
            const gpSelect = document.getElementById('grandPrixSelect');
            gpSelect.innerHTML = '<option value="">Choose Grand Prix...</option>';

            const grandPrixList = grandPrixByYear[year] || grandPrixByYear[2024];

            grandPrixList.forEach(gp => {
                const option = document.createElement('option');
                option.value = gp;
                option.textContent = gp + ' Grand Prix';
                gpSelect.appendChild(option);
            });
        }

        async function onGrandPrixChange() {
            const grandPrix = document.getElementById('grandPrixSelect').value;
            const gpStep = document.getElementById('grandPrixStep');

            if (grandPrix) {
                gpStep.classList.add('loading');
                currentSelection.grandPrix = grandPrix;

                // Reset subsequent selections
                resetSubsequentSelections(['session', 'driver']);

                // Populate session dropdown
                await populateSessionDropdown();

                gpStep.classList.remove('loading');
                document.getElementById('sessionSelect').disabled = false;

                showNotification(`‚úÖ ${grandPrix} Grand Prix selected. Choose a session type.`, 'success');
            } else {
                currentSelection.grandPrix = null;
                resetSubsequentSelections(['session', 'driver']);
                document.getElementById('sessionSelect').disabled = true;
            }

            updateProgress();
        }

        async function populateSessionDropdown() {
            const sessionSelect = document.getElementById('sessionSelect');
            sessionSelect.innerHTML = '<option value="">Choose Session...</option>';

            sessionTypes.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                sessionSelect.appendChild(option);
            });
        }

        async function onSessionChange() {
            const session = document.getElementById('sessionSelect').value;
            const sessionStep = document.getElementById('sessionStep');

            if (session) {
                sessionStep.classList.add('loading');
                currentSelection.session = session;

                // Reset driver selection
                resetSubsequentSelections(['driver']);

                try {
                    // Load session data and available drivers
                    await loadSessionData();
                    await populateDriverDropdown();

                    document.getElementById('driver1Select').disabled = false;
                    document.getElementById('driver2Select').disabled = false;
                    showNotification(`‚úÖ ${session} session selected. Choose a driver for analysis.`, 'success');
                } catch (error) {
                    showNotification(`‚ùå Error loading session data: ${error.message}`, 'error');
                    currentSelection.session = null;
                }

                sessionStep.classList.remove('loading');
            } else {
                currentSelection.session = null;
                resetSubsequentSelections(['driver']);
                document.getElementById('driverSelect').disabled = true;
            }

            updateProgress();
        }

        async function loadSessionData() {
            const { year, grandPrix, session } = currentSelection;

            const response = await fetch(`/api/session-data?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            sessionData = data;
            availableDrivers = data.drivers || [];

            // Update session summary
            updateSessionSummary(data);
        }

        function updateSessionSummary(data) {
            const summaryDiv = document.getElementById('dataSummary');
            const summaryContent = document.getElementById('summaryContent');

            summaryContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${availableDrivers.length}</div>
                        <div class="stat-label">Drivers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.laps_count || 0}</div>
                        <div class="stat-label">Total Laps</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${currentSelection.year}</div>
                        <div class="stat-label">Season</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${currentSelection.session}</div>
                        <div class="stat-label">Session</div>
                    </div>
                </div>
                <p><strong>Circuit:</strong> ${data.session_info?.circuit || currentSelection.grandPrix}</p>
                <p><strong>Date:</strong> ${data.session_info?.date || 'N/A'}</p>
            `;

            summaryDiv.style.display = 'block';
        }

        async function populateDriverDropdown() {
            const driver1Select = document.getElementById('driver1Select');
            const driver2Select = document.getElementById('driver2Select');

            driver1Select.innerHTML = '<option value="">Choose Driver 1...</option>';
            driver2Select.innerHTML = '<option value="">Choose Driver 2...</option>';

            // Enhanced driver code to full name mapping with 2024-2025 grid
            const driverNames = {
                'VER': 'Max Verstappen',
                'LEC': 'Charles Leclerc',
                'SAI': 'Carlos Sainz',
                'RUS': 'George Russell',
                'HAM': 'Lewis Hamilton',
                'NOR': 'Lando Norris',
                'PIA': 'Oscar Piastri',
                'ALO': 'Fernando Alonso',
                'STR': 'Lance Stroll',
                'PER': 'Sergio Perez',
                'GAS': 'Pierre Gasly',
                'OCO': 'Esteban Ocon',
                'ALB': 'Alexander Albon',
                'SAR': 'Logan Sargeant',
                'TSU': 'Yuki Tsunoda',
                'RIC': 'Daniel Ricciardo',
                'HUL': 'Nico Hulkenberg',
                'MAG': 'Kevin Magnussen',
                'BOT': 'Valtteri Bottas',
                'ZHO': 'Zhou Guanyu',
                'DEV': 'Nyck de Vries',
                'LAW': 'Liam Lawson',
                'BEA': 'Oliver Bearman',
                'COL': 'Franco Colapinto',
                'DRU': 'Felipe Drugovich',
                'HAD': 'Nyck de Vries',
                'POL': 'Th√©o Pourchaire'
            };

            // Function to get driver display name
            function getDriverDisplayName(driverCode) {
                return driverNames[driverCode] || driverCode;
            }

            availableDrivers.forEach(driver => {
                const option1 = document.createElement('option');
                option1.value = driver;
                option1.textContent = getDriverDisplayName(driver);
                driver1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = driver;
                option2.textContent = getDriverDisplayName(driver);
                driver2Select.appendChild(option2);
            });
        }

        function onDriver1Change() {
            const driver1 = document.getElementById('driver1Select').value;

            if (driver1) {
                currentSelection.driver1 = driver1;
                showNotification(`üèéÔ∏è Driver 1: ${driver1} selected!`, 'success');
            } else {
                currentSelection.driver1 = null;
            }

            updateProgress();
        }

        function onDriver2Change() {
            const driver2 = document.getElementById('driver2Select').value;

            if (driver2) {
                currentSelection.driver2 = driver2;
                showNotification(`üèéÔ∏è Driver 2: ${driver2} selected!`, 'success');
            } else {
                currentSelection.driver2 = null;
            }

            updateProgress();
        }

        function resetSubsequentSelections(selections) {
            selections.forEach(selection => {
                if (selection === 'driver') {
                    currentSelection.driver1 = null;
                    currentSelection.driver2 = null;
                    const driver1Select = document.getElementById('driver1Select');
                    const driver2Select = document.getElementById('driver2Select');
                    driver1Select.selectedIndex = 0;
                    driver2Select.selectedIndex = 0;
                    driver1Select.disabled = true;
                    driver2Select.disabled = true;
                    driver1Select.innerHTML = '<option value="">First select session...</option>';
                    driver2Select.innerHTML = '<option value="">First select session...</option>';
                } else {
                    currentSelection[selection] = null;
                    const selectElement = document.getElementById(selection + 'Select');
                    selectElement.selectedIndex = 0;
                    selectElement.disabled = true;

                    if (selection === 'grandPrix') {
                        selectElement.innerHTML = '<option value="">First select a year...</option>';
                    } else if (selection === 'session') {
                        selectElement.innerHTML = '<option value="">First select Grand Prix...</option>';
                    }
                }
            });

            if (selections.includes('session')) {
                document.getElementById('dataSummary').style.display = 'none';
                sessionData = null;
                availableDrivers = [];
            }
        }

        async function loadTelemetryData() {
            const { year, grandPrix, session, driver1, driver2 } = currentSelection;

            if (!year || !grandPrix || !session || (!driver1 && !driver2)) {
                showNotification('‚ùå Please complete session selection and choose at least one driver', 'error');
                return;
            }

            const output = document.getElementById('telemetryOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading detailed telemetry data...</div>';

            try {
                const drivers = [driver1, driver2].filter(d => d);
                const driverParams = drivers.map(d => `drivers=${d}`).join('&');
                const response = await fetch(`/api/telemetry?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&${driverParams}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                currentTelemetryData = data;
                displayTelemetryData(data);
                showNotification('‚úÖ Telemetry data loaded successfully!', 'success');

                // Enable chart tabs
                ['chartsTabBtn', 'comparisonTabBtn', 'analysisTabBtn'].forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });

            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading telemetry: ${error.message}</div>`;
                showNotification(`‚ùå Failed to load telemetry data: ${error.message}`, 'error');
            }
        }

        function formatLapTime(lapTimeString) {
            if (!lapTimeString || lapTimeString === 'N/A') return 'N/A';

            // Handle format like "0 days 00:01:32.310000"
            if (lapTimeString.includes('days')) {
                const timePart = lapTimeString.split(' ')[2]; // Get "00:01:32.310000"
                const parts = timePart.split(':');
                const minutes = parseInt(parts[1]);
                const seconds = parseFloat(parts[2]);
                return `${minutes}:${seconds.toFixed(3).padStart(6, '0')}`;
            }

            // Handle other formats
            return lapTimeString;
        }

        function displayTelemetryData(data) {
            const output = document.getElementById('telemetryOutput');
            const telemetryKeys = Object.keys(data.telemetry_data);

            if (telemetryKeys.length === 0) {
                output.innerHTML = '<div class="error">‚ùå No telemetry data available for the selected drivers</div>';
                return;
            }

            // Update Enhanced Telemetry Overview
            updateEnhancedTelemetryOverview(data);

            // Show comprehensive driver data
            let outputHtml = `
                <div class="response-content">
                    <div class="success">
                        <h3>‚úÖ Enhanced Telemetry Overview - ${telemetryKeys.length} Driver${telemetryKeys.length > 1 ? 's' : ''}</h3>
                        <p>Session: <strong>${data.session_info?.session || currentSelection.session}</strong> | ${data.session_info?.grand_prix || currentSelection.grandPrix} ${data.session_info?.year || currentSelection.year}</p>
                    </div>`;

            // Display data for each driver
            telemetryKeys.forEach((driver, index) => {
                const driverData = data.telemetry_data[driver];
                const driverDisplayName = getDriverDisplayName(driver);
                const formattedLapTime = formatLapTime(driverData.lap_time);

                outputHtml += `
                    <div class="driver-telemetry-section" style="margin: 2rem 0; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: var(--surface);">
                        <div class="driver-header">
                            <h3 style="color: var(--primary-red); margin: 0 0 1rem 0;">üèéÔ∏è ${driverDisplayName} (${driver})</h3>
                            <div class="driver-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="stat-card" style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">${formattedLapTime}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Best Lap Time</div>
                                </div>
                                <div class="stat-card" style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">${Math.max(...driverData.speed).toFixed(0)} km/h</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Top Speed</div>
                                </div>
                                <div class="stat-card" style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">${Math.max(...driverData.rpm)}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Max RPM</div>
                                </div>
                                <div class="stat-card" style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">${Math.max(...driverData.gear)}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Highest Gear</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="raw-data-section">
                            <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">üìä Detailed Telemetry Data</h4>
                            <div style="background: var(--background); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">
                                <strong>Speed:</strong> [${driverData.speed.slice(0, 10).join(', ')}${driverData.speed.length > 10 ? '...' : ''}]<br>
                                <strong>Throttle:</strong> [${driverData.throttle.slice(0, 10).join(', ')}${driverData.throttle.length > 10 ? '...' : ''}]<br>
                                <strong>Brake:</strong> [${driverData.brake.slice(0, 10).join(', ')}${driverData.brake.length > 10 ? '...' : ''}]<br>
                                <strong>RPM:</strong> [${driverData.rpm.slice(0, 10).join(', ')}${driverData.rpm.length > 10 ? '...' : ''}]<br>
                                <strong>Gear:</strong> [${driverData.gear.slice(0, 10).join(', ')}${driverData.gear.length > 10 ? '...' : ''}]<br>
                                <strong>Distance:</strong> [${driverData.distance.slice(0, 10).join(', ')}${driverData.distance.length > 10 ? '...' : ''}]
                            </div>
                        </div>
                    </div>
                `;
            });

            outputHtml += `</div>`;

            output.innerHTML = outputHtml;
        }

        function updateEnhancedTelemetryOverview(data) {
            const overviewDiv = document.getElementById('telemetryOverview');
            const telemetryKeys = Object.keys(data.telemetry_data);
            
            // Update driver cards based on available data
            if (telemetryKeys.length > 0) {
                const driver1 = telemetryKeys[0];
                const driver1Data = data.telemetry_data[driver1];
                updateDriverOverviewCard('driver1', driver1, driver1Data);
            }
            
            if (telemetryKeys.length > 1) {
                const driver2 = telemetryKeys[1];
                const driver2Data = data.telemetry_data[driver2];
                updateDriverOverviewCard('driver2', driver2, driver2Data);
            }
            
            overviewDiv.style.display = 'block';
        }

        function updateDriverOverviewCard(cardPrefix, driverCode, driverData) {
            const nameElement = document.getElementById(`${cardPrefix}Name`);
            const badgeElement = document.getElementById(`${cardPrefix}Badge`);
            const analyticsElement = document.getElementById(`${cardPrefix}Analytics`);
            
            const driverDisplayName = getDriverDisplayName(driverCode);
            const formattedLapTime = formatLapTime(driverData.lap_time);
            
            nameElement.textContent = driverDisplayName;
            badgeElement.textContent = driverCode;
            
            analyticsElement.innerHTML = `
                <div class="analytic-item">
                    <div class="analytic-value">${formattedLapTime}</div>
                    <div class="analytic-label">Best Lap Time</div>
                </div>
                <div class="analytic-item">
                    <div class="analytic-value">${Math.max(...driverData.speed).toFixed(0)} km/h</div>
                    <div class="analytic-label">Top Speed</div>
                </div>
                <div class="analytic-item">
                    <div class="analytic-value">${Math.max(...driverData.rpm)}</div>
                    <div class="analytic-label">Max RPM</div>
                </div>
                <div class="analytic-item">
                    <div class="analytic-value">${Math.max(...driverData.gear)}</div>
                    <div class="analytic-label">Highest Gear</div>
                </div>
                <div class="analytic-item">
                    <div class="analytic-value">${Math.max(...driverData.brake).toFixed(1)}%</div>
                    <div class="analytic-label">Max Braking</div>
                </div>
                <div class="analytic-item">
                    <div class="analytic-value">${Math.max(...driverData.throttle)}%</div>
                    <div class="analytic-label">Max Throttle</div>
                </div>
            `;
        }

        // Enhanced driver name mapping function
        function getDriverDisplayName(driverCode) {
            const driverNames = {
                'VER': 'Max Verstappen',
                'LEC': 'Charles Leclerc',
                'SAI': 'Carlos Sainz',
                'RUS': 'George Russell',
                'HAM': 'Lewis Hamilton',
                'NOR': 'Lando Norris',
                'PIA': 'Oscar Piastri',
                'ALO': 'Fernando Alonso',
                'STR': 'Lance Stroll',
                'PER': 'Sergio Perez',
                'GAS': 'Pierre Gasly',
                'OCO': 'Esteban Ocon',
                'ALB': 'Alexander Albon',
                'SAR': 'Logan Sargeant',
                'TSU': 'Yuki Tsunoda',
                'RIC': 'Daniel Ricciardo',
                'HUL': 'Nico Hulkenberg',
                'MAG': 'Kevin Magnussen',
                'BOT': 'Valtteri Bottas',
                'ZHO': 'Zhou Guanyu',
                'DEV': 'Nyck de Vries',
                'LAW': 'Liam Lawson',
                'BEA': 'Oliver Bearman',
                'COL': 'Franco Colapinto',
                'DRU': 'Felipe Drugovich'
            };
            return driverNames[driverCode] || driverCode;
        }

        function displayComprehensiveData(data) {
            const output = document.getElementById('telemetryOutput');
                        <h4>üìä Enhanced Telemetry Overview</h4>
                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                            <div class="stat-item">
                                <div class="stat-value">${driverData.speed ? driverData.speed.length : 0}</div>
                                <div class="stat-label">Data Points</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.speed ? Math.max(...driverData.speed) : 0}</div>
                                <div class="stat-label">Max Speed (km/h)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.speed ? Math.round(driverData.speed.reduce((a,b) => a+b, 0) / driverData.speed.length) : 0}</div>
                                <div class="stat-label">Avg Speed (km/h)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.rpm ? Math.max(...driverData.rpm) : 0}</div>
                                <div class="stat-label">Max RPM</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.gear ? Math.max(...driverData.gear) : 0}</div>
                                <div class="stat-label">Max Gear</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.throttle ? Math.round(driverData.throttle.reduce((a,b) => a+b, 0) / driverData.throttle.length) : 0}%</div>
                                <div class="stat-label">Avg Throttle</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.brake ? Math.max(...driverData.brake) : 0}%</div>
                                <div class="stat-label">Max Brake</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${driverData.distance ? Math.round(driverData.distance[driverData.distance.length-1] / 1000 * 100) / 100 : 0}</div>
                                <div class="stat-label">Lap Distance (km)</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--background); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-red);">üèéÔ∏è Performance Metrics</h5>
                                    <p><strong>Top Speed Zone:</strong> ${driverData.speed ? (driverData.distance[driverData.speed.indexOf(Math.max(...driverData.speed))] / 1000).toFixed(2) + 'km' : 'N/A'}</p>
                                    <p><strong>Gear Changes:</strong> ${driverData.gear ? driverData.gear.filter((g, i) => i > 0 && g !== driverData.gear[i-1]).length : 0}</p>
                                </div>
                                <div>
                                    <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-red);">‚ö° Power Unit Data</h5>
                                    <p><strong>RPM Range:</strong> ${driverData.rpm ? Math.min(...driverData.rpm) + ' - ' + Math.max(...driverData.rpm) : 'N/A'}</p>
                                    <p><strong>Throttle Usage:</strong> ${driverData.throttle ? Math.round(driverData.throttle.filter(t => t > 90).length / driverData.throttle.length * 100) : 0}% full throttle</p>
                                </div>
                                <div>
                                    <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-red);">üõë Braking Analysis</h5>
                                    <p><strong>Braking Zones:</strong> ${driverData.brake ? driverData.brake.filter(b => b > 50).length : 0} heavy braking points</p>
                                    <p><strong>Brake Efficiency:</strong> ${driverData.brake ? Math.round(driverData.brake.filter(b => b > 0).length / driverData.brake.length * 100) : 0}% brake usage</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="telemetry-data">
                        <h4>üîß Raw Telemetry Data</h4>
                        <p><em>Switch to "Interactive Charts" tab for visual analysis</em></p>
                        <details>
                            <summary>View Raw JSON Data</summary>
                            <pre><code>${JSON.stringify(data.telemetry_data, null, 2)}</code></pre>
                        </details>
                    </div>
                </div>
            `;
        }

        async function loadDriverComparison() {
            const { year, grandPrix, session } = currentSelection;

            if (!year || !grandPrix || !session) {
                showNotification('‚ùå Please select year, grand prix, and session first', 'error');
                return;
            }

            const output = document.getElementById('comparisonOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading driver comparison...</div>';

            try {
                // Load comparison for available drivers (limit to first 5 for performance)
                const drivers = availableDrivers.slice(0, 5);
                const driverParams = drivers.map(d => `drivers=${encodeURIComponent(d)}`).join('&');

                const response = await fetch(`/api/driver-comparison?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&${driverParams}`);
                const data = await response.json();

                output.innerHTML = `
                    <div class="response-content">
                        <h3>üîÑ Driver Comparison Analysis</h3>
                        <p><strong>Comparing:</strong> ${drivers.join(', ')}</p>
                        <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </div>
                `;

                showNotification('‚úÖ Driver comparison loaded successfully!', 'success');

            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading comparison: ${error.message}</div>`;
                showNotification(`‚ùå Failed to load driver comparison: ${error.message}`, 'error');
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load charts if switching to charts tab and we have data
            if (tabName === 'charts' && currentTelemetryData) {
                loadTelemetryCharts();
            }
        }

        async function loadTelemetryCharts() {
            const { year, grandPrix, session, driver } = currentSelection;

            if (!year || !grandPrix || !session || !driver) {
                return;
            }

            // Show loading indicators
            document.getElementById('speedChart').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading speed chart...</div>';
            document.getElementById('throttleBrakeChart').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading throttle/brake chart...</div>';
            document.getElementById('rpmGearChart').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading RPM/gear chart...</div>';

            try {
                // Use actual telemetry data if available, otherwise create charts from current data
                if (currentTelemetryData && currentTelemetryData.telemetry_data) {
                    createChartsFromTelemetryData(currentTelemetryData.telemetry_data[driver]);
                } else {
                    const response = await fetch(`/api/telemetry?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&drivers=${driver}`);
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.telemetry_data && data.telemetry_data[driver]) {
                        createChartsFromTelemetryData(data.telemetry_data[driver]);
                    }
                }

            } catch (error) {
                console.error('Error loading telemetry charts:', error);
                document.getElementById('speedChart').innerHTML = `<div class="error">‚ùå Error loading speed chart: ${error.message}</div>`;
                document.getElementById('throttleBrakeChart').innerHTML = `<div class="error">‚ùå Error loading throttle/brake chart: ${error.message}</div>`;
                document.getElementById('rpmGearChart').innerHTML = `<div class="error">‚ùå Error loading RPM/gear chart: ${error.message}</div>`;
            }
        }

        function createChartsFromTelemetryData(driverData) {
            if (!driverData || !driverData.distance) {
                throw new Error('No telemetry data available');
            }

            const chartConfig = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                responsive: true
            };

            const layoutTemplate = {
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white', family: 'Inter, sans-serif' },
                margin: { l: 60, r: 40, t: 60, b: 60 },
                xaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    title: 'Distance (m)'
                },
                yaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)'
                }
            };

            // Speed Chart
            const speedTrace = {
                x: driverData.distance,
                y: driverData.speed,
                type: 'scatter',
                mode: 'lines',
                name: 'Speed',
                line: { color: '#FF6B6B', width: 2 }
            };

            const speedLayout = {
                ...layoutTemplate,
                title: 'üöÄ Speed Analysis',
                yaxis: { ...layoutTemplate.yaxis, title: 'Speed (km/h)' }
            };

            Plotly.newPlot('speedChart', [speedTrace], speedLayout, chartConfig);

            // Throttle & Brake Chart
            const throttleTrace = {
                x: driverData.distance,
                y: driverData.throttle,
                type: 'scatter',
                mode: 'lines',
                name: 'Throttle',
                line: { color: '#4ECDC4', width: 2 },
                yaxis: 'y'
            };

            const brakeTrace = {
                x: driverData.distance,
                y: driverData.brake,
                type: 'scatter',
                mode: 'lines',
                name: 'Brake',
                line: { color: '#FF4757', width: 2 },
                yaxis: 'y2'
            };

            const throttleBrakeLayout = {
                ...layoutTemplate,
                title: 'üéõÔ∏è Throttle & Brake Analysis',
                yaxis: { ...layoutTemplate.yaxis, title: 'Throttle %', side: 'left' },
                yaxis2: { 
                    title: 'Brake Force', 
                    overlaying: 'y', 
                    side: 'right',
                    gridcolor: 'rgba(255,255,255,0.1)'
                }
            };

            Plotly.newPlot('throttleBrakeChart', [throttleTrace, brakeTrace], throttleBrakeLayout, chartConfig);

            // RPM & Gear Chart
            const rpmTrace = {
                x: driverData.distance,
                y: driverData.rpm,
                type: 'scatter',
                mode: 'lines',
                name: 'RPM',
                line: { color: '#45B7D1', width: 2 },
                yaxis: 'y'
            };

            const gearTrace = {
                x: driverData.distance,
                y: driverData.gear,
                type: 'scatter',
                mode: 'lines',
                name: 'Gear',
                line: { color: '#96CEB4', width: 3 },
                yaxis: 'y2'
            };

            const rpmGearLayout = {
                ...layoutTemplate,
                title: '‚öôÔ∏è RPM & Gear Analysis',
                yaxis: { ...layoutTemplate.yaxis, title: 'RPM', side: 'left' },
                yaxis2: { 
                    title: 'Gear', 
                    overlaying: 'y', 
                    side: 'right',
                    gridcolor: 'rgba(255,255,255,0.1)'
                }
            };

            Plotly.newPlot('rpmGearChart', [rpmTrace, gearTrace], rpmGearLayout, chartConfig);
        }

        function exportData() {
            if (currentTelemetryData) {
                const dataStr = JSON.stringify(currentTelemetryData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `telemetry_${currentSelection.year}_${currentSelection.grandPrix}_${currentSelection.session}_${currentSelection.driver}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('‚úÖ Telemetry data exported successfully!', 'success');
            } else {
                showNotification('‚ùå No telemetry data available to export', 'error');
            }
        }

        function resetDashboard() {
            // Reset all selections
            currentSelection = { year: null, grandPrix: null, session: null, driver1: null, driver2: null };
            currentTelemetryData = null;
            sessionData = null;
            availableDrivers = [];

            // Reset all dropdowns
            document.getElementById('yearSelect').selectedIndex = 0;
            resetSubsequentSelections(['grandPrix', 'session', 'driver']);

            // Reset progress
            updateProgress();

            // Reset outputs
            document.getElementById('telemetryOutput').innerHTML = 
                '<p class="placeholder-text">üèÅ Complete the 4-step selection process above to view detailed telemetry analysis for both selected drivers</p>';

            document.getElementById('comparisonOutput').innerHTML = 
                '<p class="placeholder-text">Driver comparison analysis will appear here after completing selection</p>';

            document.getElementById('analysisOutput').innerHTML = 
                '<p class="placeholder-text">Detailed performance analysis will appear here after completing selection</p>';

            // Clear charts
            document.getElementById('speedChart').innerHTML = '<i class="fas fa-tachometer-alt"></i><p>Speed telemetry chart will appear here after data selection</p>';
            document.getElementById('throttleBrakeChart').innerHTML = '<i class="fas fa-chart-area"></i><p>Throttle and brake telemetry chart will appear here after data selection</p>';
            document.getElementById('rpmGearChart').innerHTML = '<i class="fas fa-cogs"></i><p>RPM and gear telemetry chart will appear here after data selection</p>';

            // Hide summary and overview
            document.getElementById('dataSummary').style.display = 'none';
            document.getElementById('telemetryOverview').style.display = 'none';

            // Switch back to telemetry tab
            switchTab('telemetry');

            showNotification('üîÑ Dashboard reset successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#007bff';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        let selectedAnalysisType = 'comprehensive';

        function selectAnalysisType(type) {
            selectedAnalysisType = type;

            // Update button states
            document.querySelectorAll('.analysis-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
        }

        function populateComparisonDrivers() {
            const select1 = document.getElementById('comparisonDriver1');
            const select2 = document.getElementById('comparisonDriver2');

            // Clear existing options
            select1.innerHTML = '<option value="">Select first driver...</option>';
            select2.innerHTML = '<option value="">Select second driver...</option>';

            // Enhanced driver code to full name mapping with 2024-2025 grid
            const driverNames = {
                'VER': 'Max Verstappen',
                'LEC': 'Charles Leclerc',
                'SAI': 'Carlos Sainz',
                'RUS': 'George Russell',
                'HAM': 'Lewis Hamilton',
                'NOR': 'Lando Norris',
                'PIA': 'Oscar Piastri',
                'ALO': 'Fernando Alonso',
                'STR': 'Lance Stroll',
                'PER': 'Sergio Perez',
                'GAS': 'Pierre Gasly',
                'OCO': 'Esteban Ocon',
                'ALB': 'Alexander Albon',
                'SAR': 'Logan Sargeant',
                'TSU': 'Yuki Tsunoda',
                'RIC': 'Daniel Ricciardo',
                'HUL': 'Nico Hulkenberg',
                'MAG': 'Kevin Magnussen',
                'BOT': 'Valtteri Bottas',
                'ZHO': 'Zhou Guanyu',
                'DEV': 'Nyck de Vries',
                'LAW': 'Liam Lawson',
                'BEA': 'Oliver Bearman',
                'COL': 'Franco Colapinto',
                'DRU': 'Felipe Drugovich',
                'HAD': 'Nyck de Vries',
                'POL': 'Th√©o Pourchaire'
            };

            // Function to get driver display name
            function getDriverDisplayName(driverCode) {
                return driverNames[driverCode] || driverCode;
            }

            availableDrivers.forEach(driver => {
                const option1 = document.createElement('option');
                option1.value = driver;
                option1.textContent = getDriverDisplayName(driver);
                select1.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = driver;
                option2.textContent = getDriverDisplayName(driver);
                select2.appendChild(option2);
            });

            // Enable comparison button when both drivers selected
            select1.addEventListener('change', updateComparisonButton);
            select2.addEventListener('change', updateComparisonButton);
        }

        function updateComparisonButton() {
            const driver1 = document.getElementById('comparisonDriver1').value;
            const driver2 = document.getElementById('comparisonDriver2').value;
            const button = document.getElementById('compareDriversBtn2');

            button.disabled = !driver1 || !driver2 || driver1 === driver2;
        }

        async function performDriverComparison() {
            const { year, grandPrix, session } = currentSelection;
            const driver1 = document.getElementById('comparisonDriver1').value;
            const driver2 = document.getElementById('comparisonDriver2').value;

            if (!year || !grandPrix || !session || !driver1 || !driver2) {
                showNotification('‚ùå Please complete session selection and choose two different drivers', 'error');
                return;
            }

            const output = document.getElementById('comparisonOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading driver comparison...</div>';

            try {
                const response = await fetch(`/api/driver-comparison?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&drivers=${driver1}&drivers=${driver2}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displayDriverComparison(data, driver1, driver2);
                showNotification('‚úÖ Driver comparison loaded successfully!', 'success');

            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading comparison: ${error.message}</div>`;
                showNotification(`‚ùå Failed to load driver comparison: ${error.message}`, 'error');
            }
        }

        function displayDriverComparison(data, driver1, driver2) {
            // Enhanced driver code to full name mapping with 2024-2025 grid
            const driverNames = {
                'VER': 'Max Verstappen',
                'LEC': 'Charles Leclerc',
                'SAI': 'Carlos Sainz',
                'RUS': 'George Russell',
                'HAM': 'Lewis Hamilton',
                'NOR': 'Lando Norris',
                'PIA': 'Oscar Piastri',
                'ALO': 'Fernando Alonso',
                'STR': 'Lance Stroll',
                'PER': 'Sergio Perez',
                'GAS': 'Pierre Gasly',
                'OCO': 'Esteban Ocon',
                'ALB': 'Alexander Albon',
                'SAR': 'Logan Sargeant',
                'TSU': 'Yuki Tsunoda',
                'RIC': 'Daniel Ricciardo',
                'HUL': 'Nico Hulkenberg',
                'MAG': 'Kevin Magnussen',
                'BOT': 'Valtteri Bottas',
                'ZHO': 'Zhou Guanyu',
                'DEV': 'Nyck de Vries',
                'LAW': 'Liam Lawson',
                'BEA': 'Oliver Bearman',
                'COL': 'Franco Colapinto',
                'DRU': 'Felipe Drugovich',
                'HAD': 'Nyck de Vries',
                'POL': 'Th√©o Pourchaire'
            };

            // Function to get driver display name
            function getDriverDisplayName(driverCode) {
                return driverNames[driverCode] || driverCode;
            }
            const output = document.getElementById('comparisonOutput');

            output.innerHTML = `
                <div class="comparison-card">
                    <div class="comparison-header">
                        <div class="driver-info">
                            <span class="driver-badge">${getDriverDisplayName(driver1)}</span>
                            <span style="color: var(--text-secondary); margin: 0 1rem;">VS</span>
                            <span class="driver-badge">${getDriverDisplayName(driver2)}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${currentSelection.year} ${currentSelection.grandPrix} - ${currentSelection.session}
                        </div>
                    </div>

                    <div class="comparison-metrics">
                        <div class="metric-item">
                            <div class="metric-value">üèÜ</div>
                            <div class="metric-label">Head-to-Head Winner</div>
                            <div class="winner-badge" style="margin-top: 0.5rem;">Analysis Complete</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">üìä</div>
                            <div class="metric-label">Performance Gap</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Detailed Analysis</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">‚ö°</div>
                            <div class="metric-label">Speed Advantage</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Calculated</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">üéØ</div>
                            <div class="metric-label">Consistency</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Measured</div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--background); border-radius: 8px;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--primary-red);">üìã Detailed Comparison Data</h4>
                        <details>
                            <summary style="cursor: pointer; color: var(--text-secondary);">View Raw Comparison Data</summary>
                            <pre style="margin-top: 1rem; padding: 1rem; background: var(--surface); border-radius: 6px; overflow-x: auto;"><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </details>
                    </div>
                </div>
            `;
        }

        async function loadPerformanceAnalysis() {
            const { year, grandPrix, session, driver } = currentSelection;

            if (!year || !grandPrix || !session || !driver) {
                showNotification('‚ùå Please complete all selection steps first', 'error');
                return;
            }

            const output = document.getElementById('analysisOutput');
            output.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading performance analysis...</div>';

            try {
                let endpoint = '';
                switch (selectedAnalysisType) {
                    case 'comprehensive':
                        endpoint = `/api/telemetry/comprehensive-analysis?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&driver=${driver}`;
                        break;
                    case 'sector':
                        endpoint = `/api/sector-analysis?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}`;
                        break;
                    case 'consistency':
                        endpoint = `/api/consistency-analysis?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}`;
                        break;
                    case 'cornering':
                        endpoint = `/api/cornering-analysis?year=${year}&grand_prix=${encodeURIComponent(grandPrix)}&session=${encodeURIComponent(session)}&driver=${driver}`;
                        break;
                }

                const response = await fetch(endpoint);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displayPerformanceAnalysis(data, selectedAnalysisType);
                showNotification('‚úÖ Performance analysis loaded successfully!', 'success');

            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading analysis: ${error.message}</div>`;
            }
        }

        function displayPerformanceAnalysis(data, analysisType) {
            const output = document.getElementById('analysisOutput');
            const analysisTypes = {
                'comprehensive': 'üî¨ Comprehensive Performance Analysis',
                'sector': '‚è±Ô∏è Sector Time Analysis',
                'consistency': 'üìä Consistency Metrics',
                'cornering': 'üèÅ Cornering Performance Analysis'
            };

            const driver = currentSelection.driver1 || currentSelection.driver2 || 'N/A';

            if (analysisType === 'comprehensive' && data.driver_signature) {
                output.innerHTML = `
                    <div class="response-content">
                        <div class="success">
                            <h3>‚úÖ ${analysisTypes[analysisType]} Complete</h3>
                            <p>Analysis for: <strong>${driver}</strong> | Session: <strong>${currentSelection.session}</strong></p>
                        </div>

                        <div class="analysis-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                            <!-- Driver Signature Card -->
                            <div class="analysis-card" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                                <h4 style="margin: 0 0 1rem 0; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-fingerprint"></i> Driver Signature
                                </h4>
                                <div class="signature-grid" style="display: grid; gap: 0.75rem;">
                                    <div class="signature-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--background); border-radius: 6px;">
                                        <span>üõë Braking Style:</span>
                                        <span class="signature-value" style="font-weight: 600; color: var(--primary-red);">${data.driver_signature.braking_style.replace('_', ' ')}</span>
                                    </div>
                                    <div class="signature-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--background); border-radius: 6px;">
                                        <span>üèéÔ∏è Cornering:</span>
                                        <span class="signature-value" style="font-weight: 600; color: var(--primary-red);">${data.driver_signature.cornering_preference.replace('_', ' ')}</span>
                                    </div>
                                    <div class="signature-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--background); border-radius: 6px;">
                                        <span>‚ö° Acceleration:</span>
                                        <span class="signature-value" style="font-weight: 600; color: var(--primary-red);">${data.driver_signature.acceleration_pattern}</span>
                                    </div>
                                    <div class="signature-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--background); border-radius: 6px;">
                                        <span>‚öôÔ∏è Gear Timing:</span>
                                        <span class="signature-value" style="font-weight: 600; color: var(--primary-red);">${data.driver_signature.gear_change_timing}s</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Consistency Card -->
                            <div class="analysis-card" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                                <h4 style="margin: 0 0 1rem 0; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-heartbeat"></i> Performance Consistency
                                </h4>
                                <div class="consistency-metrics">
                                    <div class="metric-circle" style="text-align: center; margin-bottom: 1rem;">
                                        <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(var(--primary-red) ${data.performance_consistency.sector_consistency_score * 3.6}deg, var(--border) 0deg); display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                            <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-red);">
                                                ${data.performance_consistency.sector_consistency_score}
                                            </div>
                                        </div>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">Consistency Score</p>
                                    </div>
                                    <div style="display: grid; gap: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Lap Variation:</span>
                                            <span style="font-weight: 600;">${data.performance_consistency.lap_to_lap_variation}s</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Tire Management:</span>
                                            <span style="font-weight: 600; color: #28a745;">${data.performance_consistency.tire_management_rating}/10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sector Breakdown Card -->
                            <div class="analysis-card" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); grid-column: span 2;">
                                <h4 style="margin: 0 0 1rem 0; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-chart-line"></i> Sector Performance Breakdown
                                </h4>
                                <div class="sector-analysis" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    ${Object.entries(data.sector_breakdown).map((sector, index) => `
                                        <div class="sector-card" style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                            <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-red);">Sector ${index + 1}</h5>
                                            <div class="sector-performance" style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: ${sector[1].relative_performance > 100 ? '#dc3545' : '#28a745'};">
                                                    ${sector[1].relative_performance}%
                                                </div>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Relative Performance</div>
                                            </div>
                                            <div class="improvement-potential" style="margin-bottom: 0.75rem;">
                                                <div style="font-weight: 600; color: var(--primary-red);">-${sector[1].improvement_potential}s</div>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Improvement Potential</div>
                                            </div>
                                            <div class="time-loss-factors" style="font-size: 0.8rem;">
                                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Issues:</div>
                                                ${sector[1].time_loss_factors.map(factor => `
                                                    <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">‚Ä¢ ${factor.replace('_', ' ')}</div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- AI Coaching Insights Card -->
                            <div class="analysis-card" style="background: var(--surface); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); grid-column: span 2;">
                                <h4 style="margin: 0 0 1rem 0; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-robot"></i> AI Coaching Insights
                                </h4>
                                <div class="coaching-insights" style="display: grid; gap: 0.75rem;">
                                    ${data.ai_coaching_insights.map((insight, index) => `
                                        <div class="insight-item" style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: var(--background); border-radius: 8px; border-left: 4px solid var(--primary-red);">
                                            <div style="background: var(--primary-red); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;">
                                                ${index + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <p style="margin: 0; color: var(--text-primary);">${insight}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Fallback for other analysis types or incomplete data
                output.innerHTML = `
                    <div class="response-content">
                        <div class="success">
                            <h3>‚úÖ ${analysisTypes[analysisType]} Complete</h3>
                            <p>Analysis for: <strong>${driver}</strong> | Session: <strong>${currentSelection.session}</strong></p>
                        </div>

                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);">
                            <h4 style="margin: 0 0 1rem 0; color: var(--primary-red);">üìä Analysis Results</h4>
                            <pre style="background: var(--background); padding: 1rem; border-radius: 8px; overflow-x: auto; color: var(--text-primary); font-size: 0.9rem;"><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </div>
                    </div>
                `;
            }
        }

        // Update progress function to populate comparison drivers
        function updateProgress() {
            const coreSteps = ['year', 'grandPrix', 'session'];
            let completedSteps = 0;

            coreSteps.forEach((step, index) => {
                const stepElement = document.getElementById(step + 'Step');
                if (currentSelection[step]) {
                    stepElement.classList.add('completed');
                    stepElement.classList.remove('active');
                    completedSteps++;
                } else {
                    stepElement.classList.remove('completed');
                    if (index === completedSteps) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }
            });

            // Handle driver step separately
            const driverStep = document.getElementById('driverStep');
            const hasDriver1 = currentSelection.driver1;
            const hasDriver2 = currentSelection.driver2;

            if (hasDriver1 || hasDriver2) {
                driverStep.classList.add('completed');
                driverStep.classList.remove('active');
                completedSteps++;
            } else {
                driverStep.classList.remove('completed');
                if (completedSteps === 3) {
                    driverStep.classList.add('active');
                } else {
                    driverStep.classList.remove('active');
                }
            }

            const progressPercent = (completedSteps / 4) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';

            const progressMessages = [
                'Step 1: Select a year to begin telemetry analysis',
                'Step 2: Choose a Grand Prix from the selected season',
                'Step 3: Select a session type for detailed analysis',
                'Step 4: Choose one or two drivers for comparison',
                '‚úÖ All steps completed! Ready for telemetry analysis'
            ];

            document.getElementById('progressText').textContent = progressMessages[completedSteps];

            // Enable/disable action buttons
            const allStepsComplete = completedSteps === 4;
            const hasAnyDriver = hasDriver1 || hasDriver2;
            document.getElementById('loadTelemetryBtn').disabled = !hasAnyDriver || completedSteps < 3;
            document.getElementById('compareDriversBtn').disabled = completedSteps < 3;
            document.getElementById('loadAnalysisBtn').disabled = !hasAnyDriver || completedSteps < 3;

            // Enable/disable tabs
            ['chartsTabBtn', 'comparisonTabBtn', 'analysisTabBtn'].forEach(btnId => {
                document.getElementById(btnId).disabled = !hasAnyDriver || completedSteps < 3;
            });

            // Populate comparison drivers if session is selected
            if (completedSteps >= 3 && availableDrivers.length > 0) {
                populateComparisonDrivers();
            }
        }

        // Add CSS for notification animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>